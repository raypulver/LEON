"use strict";(function(){var t=this,r=(t.LEON,1),e=1,n=0,f=2,s=4,u=6,h=7,a=128,o=9,d=16,c=32,p=33,l=64,I=20,b=21,g=22,w=23,y=24,E=25,S=26,L=255,O={CHAR:e|n,UNSIGNED_CHAR:n,SHORT:e|f,UNSIGNED_SHORT:f,INT:e|s,UNSIGNED_INT:s,FLOAT:u,DOUBLE:h,ARRAY:a,OBJECT:o,STRING:d,BOOLEAN:c&p,NULL:l,UNDEFINED:I,DATE:b,BUFFER:g,REGEXP:w,MINUS_INFINITY:S,POSITIVE_INFINITY:E},v=function(){function t(r){return this instanceof t?void(this.buffer=r?r:""):new t(r)}function v(t,r){var e=0;if(r>0)for(;r>e;)t*=2,e++;else for(r=-r;r>e;)t/=2,e++;return t}function V(t,r){return r>31||!r?~t:(t^x(r))+1}function x(t){return(1<<t)-1}function C(t){return this instanceof C?(this.buffer=t,void(this.i=0)):new C(t)}function N(t,r){return this instanceof N?(this.buffer=C(t),this.state=0,this.stringIndex=[],this.objectLayoutIndex=[],void(this.spec=r)):new N(t,r)}function U(t,r){var i;if("object"==typeof t){if(null===t)return l;if(Array.isArray(t))return a;if(i=toString.call(t),"[object Date]"===i)return b;if("[object RegExp]"===i)return w;try{if(Buffer.isBuffer(t))return g}catch(L){try{if(t instanceof StringBuffer)return g}catch(L){}}return o}if("function"==typeof t||"undefined"==typeof t)return I;if("boolean"==typeof t)return t?c:p;if("string"==typeof t)return d;if("number"==typeof t){if(t!==t)return y;if(t===Number.NEGATIVE_INFINITY)return S;if(t===Number.POSITIVE_INFINITY)return E;var O=0,v=0,V=t;if(V%1||r){if(V=Math.abs(V),1>V)for(;1>V;--O,V*=2);else for(;V>2;++O,V/=2);for(;V%1!==0;v++,V*=2)if(v>23)return h;return-128>O||O>127?h:u}return 0>V?Math.abs(V)<64?e|n:Math.abs(V)<16384?e|f:Math.abs(V)<1<<30?e|s:h:128>V?n:32768>V?f:V<Math.pow(2,32)?s:h}}function m(r,e){return this instanceof m?(this.payload=r,this.buffer=t(),void(this.spec=e)):new m(r,e)}function j(t,r,e){for(var i,n,f,s=0,u=Object.getOwnPropertyNames(t).map(function(t){return r.indexOf(t)}).sort(function(t,r){return t-r});s<e.length;)if(f=!1,u.length===e[s].length){for(n=e[s].slice().sort(function(t,r){return t-r}),i=0;i<u.length;++i)if(n=e[s].slice().sort(function(t,r){return t-r}),u[i]!==n[i]){f=!0;break}if(!f)return s;++s}else++s}function A(t){return t=t.toString(),[t.substr(1,t.lastIndexOf("/")-1),t.substr(t.lastIndexOf("/")+1)]}function T(t,r,e,i){var n,f;if(e||(e=[]),void 0===i&&(i=t),"object"==typeof i&&!Buffer.isBuffer(i)&&"[object RegExp]"!==toString.call(i)&&"[object Date]"!==toString.call(i)&&null!==i)for(n=Object.getOwnPropertyNames(i),Array.isArray(i)||"[object Date]"===toString.call(i)||(e.push([]),n.forEach(function(t){e[e.length-1].push(r.indexOf(t))})),f=0;f<n.length;++f)T(t,r,e,i[n[f]]);return e}function M(t,r,e){r||(r=[]),void 0===e&&(e=t);var i,n;if("object"!=typeof e||"[object RegExp]"===toString.call(e)||"[object Date]"===toString.call(e)||Buffer.isBuffer(e))"string"==typeof e&&R(r,e);else for(i=Object.getOwnPropertyNames(e),Array.isArray(e)||i.forEach(function(t){R(r,t)}),n=0;n<i.length;++n)M(t,r,e[i[n]]);return r}function D(t){var r=U(t[0]);if("number"==typeof t[0]){for(var e=Math.abs(t[0]),i=t[0]%1!==0,n=t[0]<0?1:0,f=1;f<t.length;++f){if("number"!=typeof t[f])throw Error("Received a non-numerical value in an array of numbers.");Math.abs(t[f])>e&&(e=Math.abs(t[f])),t[f]%1!==0&&(i=!0),t[f]<0&&(n=1)}return U((n?-1:1)*e,i)}if(r===a)return[D(t.reduce(function(t,r){return t.concat(r)},[]))];if(r===o){var s={};return Object.getOwnPropertyNames(t[0]).forEach(function(r){s[r]=D(F(t,r))}),s}r===p&&(r=c);for(var u,f=1;f<t.length;++f)if(u=U(t[f]),u===p&&(u=c),u!==r)throw new Error("Type mismatch.");return r}function F(t,r){for(var e=[],i=0;i<t.length;++i){if("object"!=typeof t[i])throw Error("Received a non-object value when an object was expected.");if("undefined"==typeof t[i][r])throw Error("Object "+JSON.stringify(t[i])+" has no property "+String(r)+".");e.push(t[i][r])}return e}function B(t){var r=U(t);if(r===a)return[D(t)];if(r===o){var e={};return Object.getOwnPropertyNames(t).forEach(function(r){e[r]=B(t[r])}),e}return r===p?c:r}function R(t,r){-1===t.indexOf(r)&&t.push(r)}function P(r){return N(t(r)).parseSI().parseOLI().parseValue()}function _(t){return m(t).writeSI().writeOLI().writeData()["export"]()}function W(t){return this instanceof W?void(this.spec=t):new W(t)}t.concat=function(r){return t(r.reduce(function(t,r){return t+r.buffer},""))},t.fromString=function(r){for(var e=t(),i=0;r[i];)e.writeUInt8(r.charCodeAt(i),i),i++;return e},t.prototype={writeUInt8:function(t,r){return t=+t,r===this.buffer.length||-1===r?this.buffer+=String.fromCharCode(t):this.buffer=this.buffer.substr(0,r)+String.fromCharCode(t)+this.buffer.substr(r+1),r+1},writeInt8:function(t,r){return t=+t,t=0>t?V(-t,8):t,r===this.buffer.length||-1===r?this.buffer+=String.fromCharCode(t):this.buffer=this.buffer.substr(0,r)+String.fromCharCode(t)+this.buffer.substr(r+1),r+1},writeUInt16LE:function(t,r){return t=+t,r===this.buffer.length||-1===r?(this.buffer+=String.fromCharCode(255&t),this.buffer+=String.fromCharCode(t>>>8)):this.buffer=this.buffer.substr(0,r)+String.fromCharCode(255&t)+String.fromCharCode(t>>>8)+this.buffer.substr(r+2),r+2},writeInt16LE:function(t,r){return t=+t,t=0>t?V(-t,16):t,this.writeUInt16LE(t,r)},writeUInt32LE:function(t,r){t=+t,r===this.buffer.length||-1===r?this.buffer+=String.fromCharCode(255&t)+String.fromCharCode(t>>>8&255)+String.fromCharCode(t>>>16&255)+String.fromCharCode(t>>>24&255):this.buffer=this.buffer.substr(0,r)+String.fromCharCode(255&t)+String.fromCharCode(t>>>8&255)+String.fromCharCode(t>>>16&255)+String.fromCharCode(t>>>24&255)+this.buffer.substr(r+4)},writeInt32LE:function(t,r){return t=+t,t=0>t?V(-t,32):t,this.writeUInt32LE(t,r)},writeFloatLE:function(t,r){t=+t;var e,i,n=127,f=t;e=0>f?1:0,f=Math.abs(f),i=Math.log(f)/Math.log(2),i=i>0?Math.floor(i):Math.ceil(i),f*=Math.pow(2,-i+23),n+=i,f=Math.round(f);var s=[];s.push(e<<7),s[0]+=(254&n)>>>1,s.push((1&n)<<7),s[1]+=f>>>16&127,s.push(f>>>8&255),s.push(255&f);for(var u=s.length-1;u>=0;--u)this.writeUInt8(s[u],r+(s.length-1-u));return r+4},writeDoubleLE:function(t,r){t=+t;var e,i,n=1023,f=t;e=0>f?1:0,f=Math.abs(f),i=Math.log(f)/Math.log(2),i=i>0?Math.floor(i):Math.ceil(i),f*=Math.pow(2,-i+52),n+=i,f=Math.round(f),f=parseInt(f.toString(2).substr(1),2);var s=[];s.push(e<<7),s[0]+=n>>>4,s.push((15&n)<<4),s[1]+=15&Math.floor(v(f,-48));for(var u=40,h=0;6>h;++h,u-=8)s.push(255&Math.floor(v(f,-u)));for(h=s.length-1;h>=0;--h)this.writeUInt8(s[h],r+(s.length-1-h));return r+8},readUInt8:function(t){return t>>>=0,this.buffer.charCodeAt(t)},readInt8:function(t){t>>>=0;var r=this.buffer.charCodeAt(t);return 128&r?-V(r,8):r},readUInt16LE:function(t){return t>>>=0,this.buffer.charCodeAt(t)|this.buffer.charCodeAt(t+1)<<8},readInt16LE:function(t){var r=this.readUInt16LE(t);return 32768&r?-V(r,16):r},readUInt32LE:function(t){return t>>>=0,this.buffer.charCodeAt(t)|this.buffer.charCodeAt(t+1)<<8|this.buffer.charCodeAt(t+2)<<16|this.buffer.charCodeAt(t+3)<<24},readInt32LE:function(t){var r=this.readUInt32LE(t);return 2147483648&r?-V(r,32):r},readFloatLE:function(t){for(var r=[],e=0;4>e;++e)r.push(this.readUInt8(t+e));r.reverse();var i=(128&r[0])>>>7,n=((127&r[0])<<1)+((128&r[1])>>>7),f=0;for(r[1]&=127,e=0;2>=e;++e)f+=r[e+1]<<8*(2-e);return f|=8388608,v(i?-f:f,n-150)},readDoubleLE:function(t){for(var r=[],e=0;8>e;++e)r.push(this.readUInt8(t+e));r.reverse();var i=(128&r[0])>>>7,n=((127&r[0])<<4)+((240&r[1])>>>4),f=0;for(r[1]&=15,e=0;6>=e;++e)f+=v(r[e+1],8*(6-e));return f+=4503599627370496,v(i?-f:f,n-1075)}},C.prototype={exhausted:function(){return i>=this.buffer.length},readUInt8:function(){return this.i++,this.buffer.readUInt8(this.i-1)},readInt8:function(){return this.i++,this.buffer.readInt8(this.i-1)},readUInt16:function(){return this.i+=2,this.buffer.readUInt16LE(this.i-2)},readInt16:function(){return this.i+=2,this.buffer.readInt16LE(this.i-2)},readUInt32:function(){return this.i+=4,this.buffer.readUInt32LE(this.i-4)},readInt32:function(){return this.i+=4,this.buffer.readInt32LE(this.i-4)},readFloat:function(){return this.i+=4,this.buffer.readFloatLE(this.i-4)},readDouble:function(){return this.i+=8,this.buffer.readDoubleLE(this.i-8)},readValue:function(t){return t===n?this.readUInt8():t===(n|e)?this.readInt8():t===f?this.readUInt16():t===(f|e)?this.readInt16():t===s?this.readUInt32():t===(s|e)?this.readInt32():t===u?this.readFloat():t===h?this.readDouble():void 0}},N.prototype={readString:function(){for(var t="",r=this.buffer.readUInt8(),e=this.buffer.readValue(r),i=0;e>i;)t+=String.fromCharCode(this.buffer.readUInt8()),++i;return t},parseSI:function(){if(this.state&r)throw Error("Already parsed string index.");var t;switch(this.stringIndexType=this.buffer.readUInt8(),this.stringIndexType){case n:case f:case s:t=this.buffer.readValue(this.stringIndexType);break;case L:t=0;break;default:throw Error("Invalid LEON.")}for(var e=0;t>e;++e)this.stringIndex.push(this.readString());return this.state|=r,this},parseOLI:function(){if(this.state&r||this.parseSI(),!this.stringIndex.length)return this;var t,e,i,u;switch(this.OLItype=this.buffer.readUInt8(),this.OLItype){case n:case f:case s:t=this.buffer.readValue(this.OLItype);break;case L:return this;default:throw Error("Invalid LEON.")}for(i=0;t>i;++i)for(this.objectLayoutIndex.push([]),e=this.buffer.readValue(this.buffer.readUInt8()),u=0;e>u;++u)this.objectLayoutIndex[i].push(this.buffer.readValue(this.stringIndexType));return this},parseValueWithSpec:function(t){var r,e,i,n,f;if("undefined"==typeof t&&(t=this.spec),t===d)return r=this.readString();if("object"==typeof t){if(t===b)return r=this.parseValue(t);if(Array.isArray(t)){if(0===t.length)return this.parseValue(a);for(t=t[0],f=this.buffer.readUInt8(),i=this.buffer.readValue(f),r=[],e=0;i>e;++e)r.push(this.parseValueWithSpec(t));return r}for(r={},n=Object.getOwnPropertyNames(t),n.sort(function(t,r){return t>r}),e=0;e<n.length;++e)r[n[e]]=this.parseValueWithSpec(t[n[e]]);return r}return t===(c&p)?this.parseValue():this.parseValue(t)},parseValue:function(t){"undefined"==typeof t&&(t=this.buffer.readUInt8());var r,e,i,f;if(o>t)return this.buffer.readValue(t);if(t===a){for(t=this.buffer.readUInt8(),r=this.buffer.readValue(t),i=[],e=0;r>e;++e)i.push(this.parseValue());return i}if(t!==o){if(t===d)return this.stringIndex[this.buffer.readValue(this.stringIndexType)];if(t===I)return void 0;if(t===c)return!0;if(t===p)return!1;if(t===l)return null;if(t===y)return 0/0;if(t===S)return Number.NEGATIVE_INFINITY;if(t===E)return Number.POSITIVE_INFINITY;if(t===b)return new Date(1e3*this.buffer.readValue(s));if(t===g){r=this.buffer.readValue(this.buffer.readUInt8());try{i=new Buffer(r)}catch(u){try{i=StringBuffer()}catch(u){throw Error("LEON object contains a Buffer but StringBuffer has not been loaded.")}}for(e=0;r>e;++e)i.writeUInt8(this.buffer.readValue(n),e);return i}if(t===w)return RegExp(this.readString(),this.readString());throw Error("Invalid LEON.")}for(f=this.objectLayoutIndex[this.buffer.readValue(this.OLItype)],i={},e=0;e<f.length;++e)i[this.stringIndex[f[e]]]=this.parseValue();return i}},m.prototype={append:function(r){this.buffer=t.concat([this.buffer,r])},writeData:function(){return"undefined"!=typeof this.spec?this.writeValueWithSpec(this.payload):this.writeValue(this.payload,U(this.payload)),this},"export":function(){return this.buffer.buffer},writeValueWithSpec:function(t,r){var e,i;if("undefined"==typeof r&&(r=this.spec),"object"==typeof r)if(Array.isArray(r))for(this.writeValue(t.length,U(t.length)),i=0;i<t.length;++i)this.writeValueWithSpec(t[i],r[0]);else if("[object Date]"===toString.call(t))this.writeValue(t,b,!0);else{e=Object.getOwnPropertyNames(r);{Object.getOwnPropertyNames(t)}for(e.sort(function(t,r){return t>r}),i=0;i<e.length;++i)this.writeValueWithSpec(t[e[i]],r[e[i]])}else r===(c&p)?this.writeValue(t,U(t),!0):this.writeValue(t,r,!0)},writeValue:function(r,i,L){var O,v,V,x,C,N=t();if(N.writeUInt8(i,0),i===I||i===c||i===p||i===l||i===y||i===S||i===E)return this.append(N),1;if(i===d)return L||this.append(N),this.stringIndex?(this.writeValue(this.stringIndex.indexOf(r),this.stringIndexType,!0),2):(this.writeString(r),2+r.length);if(i===(e|n))return L||this.append(N),O=t(),O.writeInt8(r,0),this.append(O),2;if(i===n)return L||this.append(N),O=t(),O.writeUInt8(r,0),this.append(O),2;if(i===(e|f))return L||this.append(N),O=t(),O.writeInt16LE(r,0),this.append(O),3;if(i===f)return L||this.append(N),O=t(),O.writeUInt16LE(r,0),this.append(O),3;if(i===(e|s))return L||this.append(N),O=t(),O.writeInt32LE(r,0),this.append(O),5;if(i===s)return L||this.append(N),O=t(),O.writeUInt32LE(r,0),this.append(O),5;if(i===u)return L||this.append(N),O=t(),O.writeFloatLE(r,0),this.append(O),5;if(i===h)return L||this.append(N),O=t(),O.writeDoubleLE(r,0),this.append(O),9;if(i===a)for(L||this.append(N),this.writeValue(r.length,U(r.length)),v=0;v<r.length;++v)this.writeValue(r[v],U(r[v]));if(i===o)for(L||this.append(N),x=j(r,this.stringIndex,this.OLI),L||this.writeValue(x,this.OLItype,!0),v=0;v<this.OLI[x].length;++v)V=r[this.stringIndex[this.OLI[x][v]]],this.writeValue(V,U(V));if(i===b&&(L||this.append(N),this.writeValue(Math.floor(r.valueOf()/1e3),s,!0)),i===g)for(L||this.append(N),this.writeValue(r.length,U(r.length)),v=0;v<r.length;++v)this.writeValue(r[v],n,!0);return i===w?(L||this.append(N),C=A(r),this.writeString(C[0]),this.writeString(C[1]),C.reduce(function(t,r){return t+r.length+1},0)):void 0},writeString:function(t){this.writeValue(t.length,U(t.length));for(var r=0;r<t.length;++r)this.writeValue(t.charCodeAt(r),n,!0)},writeOLI:function(t){return this.stringIndex.length?(this.OLI=T(this.payload,this.stringIndex),this.OLI.length?(this.OLItype=U(this.OLI.length),this.writeValue(this.OLI.length,this.OLItype),this.OLI.forEach(function(t){var r=U(t.length);this.writeValue(t.length,r),t.forEach(function(t){this.writeValue(t,this.stringIndexType,!0)},this)},this),this):(this.writeValue(L,n,!0),this)):this},writeSI:function(){return this.stringIndex=M(this.payload),this.stringIndex.length?(this.stringIndexType=U(this.stringIndex.length),this.writeValue(this.stringIndex.length,this.stringIndexType),this.stringIndex.forEach(function(t){this.writeString(t)},this),this):(this.writeValue(L,n,!0),this)}},W.prototype={stringify:function(t){return m(t,this.spec).writeData()["export"]()},parse:function(r){return N(t(r),this.spec).parseValueWithSpec()}};var G={};return G.types=O,G.parse=P,G.stringify=_,G.toTemplate=B,G.Channel=W,G}();"undefined"!=typeof exports?"undefined"!=typeof module&&module.exports&&(exports=module.exports=v):t.LEON=v}).call(this);