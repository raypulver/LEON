"use strict";(function(){var t=this,e=(t.LEON,1),r=1,n=0,s=2,f=4,h=6,u=7,a=128,o=9,d=16,p=32,l=33,c=64,g=20,b=21,I=22,w=23,y=24,L=255,S={};S.SignedChar=r|n,S.Char=n,S.SignedShort=r|s,S.Short=s,S.SignedInt=r|f,S.Int=f,S.Float=h,S.Double=u,S.Array=a,S.Object=o,S.String=d,S.Boolean=p&l,S.Null=c,S.Undefined=g,S.Date=b,S.Buffer=I,S.RegExp=w;var v=function(){function v(t){return this instanceof v?void(this.buffer=t?t:""):new v(t)}function V(t,e){var r=0;if(e>0)for(;e>r;)t*=2,r++;else for(e=-e;e>r;)t/=2,r++;return t}function E(t,e){return e>31||!e?~t:(t^C(e))+1}function C(t){return(1<<t)-1}function x(t){return this instanceof x?(this.buffer=t,void(this.i=0)):new x(t)}function O(t,e){return this instanceof O?(this.buffer=x(t),this.state=0,this.stringIndex=[],this.objectLayoutIndex=[],void(this.spec=e)):new O(t,e)}function U(e){var i;if("object"==typeof e)return null===e?c:Array.isArray(e)?a:(i=toString.call(e),"[object Date]"===i?b:"[object RegExp]"===i?w:"undefined"!=typeof t.Buffer&&Buffer.isBuffer(e)?I:"undefined"!=typeof t.StringBuffer&&e instanceof StringBuffer?I:o);if("function"==typeof e||"undefined"==typeof e)return g;if("boolean"==typeof e)return e?p:l;if("string"==typeof e)return d;if("number"==typeof e){if(e!==e)return y;var L=0,S=0,v=e;if(v%1){if(v=Math.abs(v),1>v)for(;1>v;--L,v*=2);else for(;v>2;++L,v/=2);for(;v%1!==0;S++,v*=2)if(S>23)return u;return-128>L||L>127?u:h}return 0>v?Math.abs(v)<64?r|n:Math.abs(v)<16384?r|s:Math.abs(v)<1<<30?r|f:u:128>v?n:32768>v?s:v<Math.pow(2,32)?f:u}}function m(t,e){return this instanceof m?(this.payload=t,this.buffer=v(),void(this.spec=e)):new m(t,e)}function M(t,e,r){for(var i,n,s,f=0,h=Object.getOwnPropertyNames(t).map(function(t){return e.indexOf(t)}).sort(function(t,e){return t-e});f<r.length;)if(s=!1,h.length===r[f].length){for(n=r[f].slice().sort(function(t,e){return t-e}),i=0;i<h.length;++i)if(n=r[f].slice().sort(function(t,e){return t-e}),h[i]!==n[i]){s=!0;break}if(!s)return f;++f}else++f}function A(t,e,r,i){var n,s;if(r||(r=[]),void 0===i&&(i=t),"object"==typeof i&&null!==i)for(n=Object.getOwnPropertyNames(i),Array.isArray(i)||"[object Date]"===toString.call(i)||(r.push([]),n.forEach(function(t){r[r.length-1].push(e.indexOf(t))})),s=0;s<n.length;++s)A(t,e,r,i[n[s]]);return r}function j(t,e,r){e||(e=[]),void 0===r&&(r=t);var i,n;if("object"==typeof r)for(i=Object.getOwnPropertyNames(r),Array.isArray(r)||i.forEach(function(t){D(e,t)}),n=0;n<i.length;++n)j(t,e,r[i[n]]);else"string"==typeof r&&D(e,r);return e}function D(t,e){-1===t.indexOf(e)&&t.push(e)}function B(t){return O(v(t)).parseSI().parseOLI().parseValue()}function N(t){return m(t).writeSI().writeOLI().writeData()["export"]()}function T(t){return this instanceof T?void(this.spec=t):new T(t)}v.concat=function(t){return v(t.reduce(function(t,e){return t+e.buffer},""))},v.fromString=function(t){for(var e=v(),r=0;t[r];)e.writeUInt8(t.charCodeAt(r),r),r++;return e},v.prototype={writeUInt8:function(t,e){return t=+t,e===this.buffer.length||-1===e?this.buffer+=String.fromCharCode(t):this.buffer=this.buffer.substr(0,e)+String.fromCharCode(t)+this.buffer.substr(e+1),e+1},writeInt8:function(t,e){return t=+t,t=0>t?E(-t,8):t,e===this.buffer.length||-1===e?this.buffer+=String.fromCharCode(t):this.buffer=this.buffer.substr(0,e)+String.fromCharCode(t)+this.buffer.substr(e+1),e+1},writeUInt16LE:function(t,e){return t=+t,e===this.buffer.length||-1===e?(this.buffer+=String.fromCharCode(255&t),this.buffer+=String.fromCharCode(t>>>8)):this.buffer=this.buffer.substr(0,e)+String.fromCharCode(255&t)+String.fromCharCode(t>>>8)+this.buffer.substr(e+2),e+2},writeInt16LE:function(t,e){return t=+t,t=0>t?E(-t,16):t,this.writeUInt16LE(t,e)},writeUInt32LE:function(t,e){t=+t,e===this.buffer.length||-1===e?this.buffer+=String.fromCharCode(255&t)+String.fromCharCode(t>>>8&255)+String.fromCharCode(t>>>16&255)+String.fromCharCode(t>>>24&255):this.buffer=this.buffer.substr(0,e)+String.fromCharCode(255&t)+String.fromCharCode(t>>>8&255)+String.fromCharCode(t>>>16&255)+String.fromCharCode(t>>>24&255)+this.buffer.substr(e+4)},writeInt32LE:function(t,e){return t=+t,t=0>t?E(-t,32):t,this.writeUInt32LE(t,e)},writeFloatLE:function(t,e){t=+t;var r,i,n=127,s=t;r=0>s?1:0,s=Math.abs(s),i=Math.log(s)/Math.log(2),i=i>0?Math.floor(i):Math.ceil(i),s*=Math.pow(2,-i+23),n+=i,s=Math.round(s);var f=[];f.push(r<<7),f[0]+=(254&n)>>>1,f.push((1&n)<<7),f[1]+=s>>>16&127,f.push(s>>>8&255),f.push(255&s);for(var h=f.length-1;h>=0;--h)this.writeUInt8(f[h],e+(f.length-1-h));return e+4},writeDoubleLE:function(t,e){t=+t;var r,i,n=1023,s=t;r=0>s?1:0,s=Math.abs(s),i=Math.log(s)/Math.log(2),i=i>0?Math.floor(i):Math.ceil(i),s*=Math.pow(2,-i+52),n+=i,s=Math.round(s),s=parseInt(s.toString(2).substr(1),2);var f=[];f.push(r<<7),f[0]+=n>>>4,f.push((15&n)<<4),f[1]+=15&Math.floor(V(s,-48));for(var h=40,u=0;6>u;++u,h-=8)f.push(255&Math.floor(V(s,-h)));for(u=f.length-1;u>=0;--u)this.writeUInt8(f[u],e+(f.length-1-u));return e+8},readUInt8:function(t){return t>>>=0,this.buffer.charCodeAt(t)},readInt8:function(t){t>>>=0;var e=this.buffer.charCodeAt(t);return 128&e?-E(e,8):e},readUInt16LE:function(t){return t>>>=0,this.buffer.charCodeAt(t)|this.buffer.charCodeAt(t+1)<<8},readInt16LE:function(t){var e=this.readUInt16LE(t);return 32768&e?-E(e,16):e},readUInt32LE:function(t){return t>>>=0,this.buffer.charCodeAt(t)|this.buffer.charCodeAt(t+1)<<8|this.buffer.charCodeAt(t+2)<<16|this.buffer.charCodeAt(t+3)<<24},readInt32LE:function(t){var e=this.readUInt32LE(t);return 2147483648&e?-E(e,32):e},readFloatLE:function(t){for(var e=[],r=0;4>r;++r)e.push(this.readUInt8(t+r));e.reverse();var i=(128&e[0])>>>7,n=((127&e[0])<<1)+((128&e[1])>>>7),s=0;for(e[1]&=127,r=0;2>=r;++r)s+=e[r+1]<<8*(2-r);return s|=8388608,V(i?-s:s,n-150)},readDoubleLE:function(t){for(var e=[],r=0;8>r;++r)e.push(this.readUInt8(t+r));e.reverse();var i=(128&e[0])>>>7,n=((127&e[0])<<4)+((240&e[1])>>>4),s=0;for(e[1]&=15,r=0;6>=r;++r)s+=V(e[r+1],8*(6-r));return s+=4503599627370496,V(i?-s:s,n-1075)}},x.prototype={exhausted:function(){return i>=this.buffer.length},readUInt8:function(){return this.i++,this.buffer.readUInt8(this.i-1)},readInt8:function(){return this.i++,this.buffer.readInt8(this.i-1)},readUInt16:function(){return this.i+=2,this.buffer.readUInt16LE(this.i-2)},readInt16:function(){return this.i+=2,this.buffer.readInt16LE(this.i-2)},readUInt32:function(){return this.i+=4,this.buffer.readUInt32LE(this.i-4)},readInt32:function(){return this.i+=4,this.buffer.readInt32LE(this.i-4)},readFloat:function(){return this.i+=4,this.buffer.readFloatLE(this.i-4)},readDouble:function(){return this.i+=8,this.buffer.readDoubleLE(this.i-8)},readValue:function(t){return t===n?this.readUInt8():t===(n|r)?this.readInt8():t===s?this.readUInt16():t===(s|r)?this.readInt16():t===f?this.readUInt32():t===(f|r)?this.readInt32():t===h?this.readFloat():t===u?this.readDouble():void 0}},O.prototype={readString:function(){for(var t,e="";;){if(t=this.buffer.readUInt8(),!t)break;e+=String.fromCharCode(t)}return e},parseSI:function(){if(this.state&e)throw Error("Already parsed string index.");var t;switch(this.stringIndexType=this.buffer.readUInt8(),this.stringIndexType){case n:case s:case f:t=this.buffer.readValue(this.stringIndexType);break;case L:t=0;break;default:throw Error("Invalid LEON.")}for(var r=0;t>r;++r)this.stringIndex.push(this.readString());return this.state|=e,this},parseOLI:function(){if(this.state&e||this.parseSI(),!this.stringIndex.length)return this;var t,r,i,h;switch(this.OLItype=this.buffer.readUInt8(),this.OLItype){case n:case s:case f:t=this.buffer.readValue(this.OLItype);break;case L:return this;default:throw Error("Invalid LEON.")}for(i=0;t>i;++i)for(this.objectLayoutIndex.push([]),r=this.buffer.readValue(this.buffer.readUInt8()),h=0;r>h;++h)this.objectLayoutIndex[i].push(this.buffer.readValue(this.stringIndexType));return this},parseValueWithSpec:function(t){var e,r,i,n,s;if("undefined"==typeof t&&(t=this.spec),t===d)return this.readString();if("object"==typeof t){if(t===b)return this.parseValue(t);if(Array.isArray(t)){if(0===t.length)return this.parseValue(a);for(t=t[0],s=this.buffer.readUInt8(),i=this.buffer.readValue(s),e=[],r=0;i>r;++r)e.push(this.parseValueWithSpec(t));return e}for(e={},n=Object.getOwnPropertyNames(t),n.sort(function(t,e){return t-e}),r=0;r<n.length;++r)e[n[r]]=this.parseValueWithSpec(t[n[r]]);return e}return t===(p&l)?this.parseValue():this.parseValue(t)},parseValue:function(e){e||(e=this.buffer.readUInt8());var r,i,s,h;if(o>e)return this.buffer.readValue(e);if(e===a){for(e=this.buffer.readUInt8(),r=this.buffer.readValue(e),s=[],i=0;r>i;++i)s.push(this.parseValue());return s}if(e!==o){if(e===d)return this.stringIndex[this.buffer.readValue(this.stringIndexType)];if(e===g)return void 0;if(e===p)return!0;if(e===l)return!1;if(e===c)return null;if(e===y)return 0/0;if(e===b)return new Date(1e3*this.buffer.readValue(f));if(e===I){if(r=this.buffer.readValue(this.buffer.readUInt8()),"undefined"==typeof t.Buffer){if("undefined"==typeof t.StringBuffer)throw Error("LEON object contains a Buffer but StringBuffer has not been loaded.");s=StringBuffer()}else s=new Buffer(r);for(i=0;r>i;++i)s.writeUInt8(this.buffer.readValue(n),i);return s}if(e===w)return RegExp(this.readString());throw Error("Invalid LEON.")}for(h=this.objectLayoutIndex[this.buffer.readValue(this.OLItype)],s={},i=0;i<h.length;++i)s[this.stringIndex[h[i]]]=this.parseValue();return s}},m.prototype={append:function(t){this.buffer=v.concat([this.buffer,t])},writeData:function(){return this.spec?this.writeValueWithSpec(this.payload):this.writeValue(this.payload,U(this.payload)),this},"export":function(){return this.buffer.buffer},writeValueWithSpec:function(t,e){var r,i;if(e||(e=this.spec),"object"==typeof e)if(Array.isArray(e))for(this.writeValue(t.length,U(t.length)),i=0;i<t.length;++i)this.writeValueWithSpec(t[i],e[0]);else if("[object Date]"===toString.call(t))this.writeValue(t,b,!0);else for(r=Object.getOwnPropertyNames(e),r.sort(function(t,e){return t-e}),i=0;i<r.length;++i)this.writeValueWithSpec(t[r[i]],e[r[i]]);else e===(p&l)?this.writeValue(t,U(t),!0):this.writeValue(t,e,!0)},writeValue:function(t,e,i){var L,S,V,E,C=v();if(C.writeUInt8(e,0),e===g||e===p||e===l||e===c||e===y)return this.append(C),1;if(e===d)return i||this.append(C),this.stringIndex?(this.writeValue(this.stringIndex.indexOf(t),this.stringIndexType,!0),2):(this.writeString(t),2+t.length);if(e===(r|n))return i||this.append(C),L=v(),L.writeInt8(t,0),this.append(L),2;if(e===n)return i||this.append(C),L=v(),L.writeUInt8(t,0),this.append(L),2;if(e===(r|s))return i||this.append(C),L=v(),L.writeInt16LE(t,0),this.append(L),3;if(e===s)return i||this.append(C),L=v(),L.writeUInt16LE(t,0),this.append(L),3;if(e===(r|f))return i||this.append(C),L=v(),L.writeInt32LE(t,0),this.append(L),5;if(e===f)return i||this.append(C),L=v(),L.writeUInt32LE(t,0),this.append(L),5;if(e===h)return i||this.append(C),L=v(),L.writeFloatLE(t,0),this.append(L),5;if(e===u)return i||this.append(C),L=v(),L.writeDoubleLE(t,0),this.append(L),9;if(e===a)for(i||this.append(C),this.writeValue(t.length,U(t.length)),S=0;S<t.length;++S)this.writeValue(t[S],U(t[S]));if(e===o)for(i||this.append(C),E=M(t,this.stringIndex,this.OLI),i||this.writeValue(E,this.OLItype,!0),S=0;S<this.OLI[E].length;++S)V=t[this.stringIndex[this.OLI[E][S]]],this.writeValue(V,U(V));if(e===b&&(i||this.append(C),this.writeValue(Math.floor(t.valueOf()/1e3),f,!0)),e===I)for(i||this.append(C),S=0;S<t.length;++S)this.writeValue(t[S],n,!0);e===w&&(i||this.append(C),this.writeString(t.toString()))},writeString:function(t){var e=v();e.writeUInt8(0,0),this.append(v.concat([v.fromString(String(t)),e]))},writeOLI:function(t){return this.stringIndex.length?(this.OLI=A(this.payload,this.stringIndex),this.OLI.length?(this.OLItype=U(this.OLI.length),this.writeValue(this.OLI.length,this.OLItype),this.OLI.forEach(function(t){var e=U(t.length);this.writeValue(t.length,e),t.forEach(function(t){this.writeValue(t,this.stringIndexType,!0)},this)},this),this):(this.writeValue(L,n,!0),this)):this},writeSI:function(){return this.stringIndex=j(this.payload),this.stringIndex.length?(this.stringIndexType=U(this.stringIndex.length),this.writeValue(this.stringIndex.length,this.stringIndexType),this.stringIndex.forEach(function(t){this.writeString(t)},this),this):(this.writeValue(L,n,!0),this)}},T.prototype={stringify:function(t){return m(t,this.spec).writeData()["export"]()},parse:function(t){return O(v(t),this.spec).parseValueWithSpec()}};var W={};return W.types=S,W.parse=B,W.stringify=N,W.Channel=T,W}();"undefined"!=typeof exports?"undefined"!=typeof module&&module.exports&&(exports=module.exports=v):t.LEON=v}).call(this);