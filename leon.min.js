"use strict";(function(){var t=this,e=(t.LEON,1),r=1,n=0,s=2,a=4,h=6,u=7,f=3,o=5,c=128,d=9,p=16,l=32,I=33,b=64,g=20,w=21,y=22,E=23,L=24,S=25,v=26,O=255,V={CHAR:r|n,UNSIGNED_CHAR:n,SHORT:r|s,UNSIGNED_SHORT:s,INT:r|a,UNSIGNED_INT:a,FLOAT:h,DOUBLE:u,ARRAY:c,OBJECT:d,STRING:p,BOOLEAN:l&I,NULL:b,UNDEFINED:g,DATE:w,BUFFER:y,REGEXP:E,MINUS_INFINITY:v,POSITIVE_INFINITY:S},x=function(){function t(e){return this instanceof t?void(this.buffer=e?e:""):new t(e)}function x(t,e,r){for(var n="",i=0;i<r-t.length;++i)n+=e;return n+=t}function N(t,e){var r,n,i,s;if(!e)return~t;if(e>31){for(r=t.toString(2),r=x(r,"0",e),n="",i=0;i<r.length;++i)n+="0"===r[i]?"1":"0";return s=parseInt(n,2),s+=1}return(t^C(e))+1}function C(t){return(1<<t)-1}function U(t){return this instanceof U?(this.buffer=t,void(this.i=0)):new U(t)}function m(t,e){return this instanceof m?(this.buffer=U(t),this.state=0,this.stringIndex=[],this.objectLayoutIndex=[],void(this.spec=e)):new m(t,e)}function M(t,e){var i;if("object"==typeof t){if(null===t)return b;if(Array.isArray(t))return c;if(i=toString.call(t),"[object Date]"===i)return w;if("[object RegExp]"===i)return E;try{if(Buffer.isBuffer(t))return y}catch(f){try{if(t instanceof StringBuffer)return y}catch(f){}}return d}if("function"==typeof t||"undefined"==typeof t)return g;if("boolean"==typeof t)return t?l:I;if("string"==typeof t)return p;if("number"==typeof t){if(t!==t)return L;if(t===Number.NEGATIVE_INFINITY)return v;if(t===Number.POSITIVE_INFINITY)return S;var o,O=0,V=t;return V%1||e?(V=Math.abs(t),o=Math.log(V)/Math.LN2,o=0>o?Math.ceil(o):Math.floor(o),O=103+o,0>O||O>255?u:(V*=Math.pow(2,-o+24),Math.floor(V)!=V?u:h)):0>V?Math.abs(V)<=128?r|n:Math.abs(V)<=32768?r|s:Math.abs(V)<=Math.pow(2,31)?r|a:u:256>V?n:65536>V?s:V<Math.pow(2,32)?a:u}}function A(e,r){return this instanceof A?(this.payload=e,this.buffer=t(),void(this.spec=r)):new A(e,r)}function T(t,e,r){for(var n,i,s,a=0,h=Object.getOwnPropertyNames(t).map(function(t){return e.indexOf(t)}).sort(function(t,e){return t-e});a<r.length;)if(s=!1,h.length===r[a].length){for(i=r[a].slice().sort(function(t,e){return t-e}),n=0;n<h.length;++n)if(h[n]!==i[n]){s=!0;break}if(!s)return a;++a}else++a}function j(t){return t=t.toString(),[t.substr(1,t.lastIndexOf("/")-1),t.substr(t.lastIndexOf("/")+1)]}function D(t,e,r,n){var i,s;if(r||(r=[]),void 0===n&&(n=t),"object"==typeof n&&!Buffer.isBuffer(n)&&"[object RegExp]"!==toString.call(n)&&"[object Date]"!==toString.call(n)&&null!==n)for(i=Object.getOwnPropertyNames(n),Array.isArray(n)||"[object Date]"===toString.call(n)||(r.push([]),i.forEach(function(t){r[r.length-1].push(e.indexOf(t))})),s=0;s<i.length;++s)D(t,e,r,n[i[s]]);return r}function F(t,e,r){e||(e=[]),void 0===r&&(r=t);var n,i;if("object"!=typeof r||"[object RegExp]"===toString.call(r)||"[object Date]"===toString.call(r)||Buffer.isBuffer(r))"string"==typeof r&&k(e,r);else for(n=Object.getOwnPropertyNames(r),Array.isArray(r)||n.forEach(function(t){k(e,t)}),i=0;i<n.length;++i)F(t,e,r[n[i]]);return e}function B(t){var e=M(t[0]);switch(e){case n:case r:case s:case f:case a:case o:case h:case u:for(var i=Math.abs(t[0]),p=t[0]%1!==0,b=t[0]<0?1:0,g=1;g<t.length;++g){if("number"!=typeof t[g])throw Error("Received a non-numerical value in an array of numbers.");Math.abs(t[g])>i&&(i=Math.abs(t[g])),t[g]%1!==0&&(p=!0),t[g]<0&&(b=1)}return M((b?-1:1)*i,p);case c:return[B(t.reduce(function(t,e){return t.concat(e)},[]))];case d:var w={};return Object.getOwnPropertyNames(t[0]).forEach(function(e){w[e]=B(R(t,e))}),w;default:e===I&&(e=l);for(var y,g=1;g<t.length;++g)if(y=M(t[g]),y===I&&(y=l),y!==e)throw new Error("Type mismatch.");return e}}function R(t,e){for(var r=[],n=0;n<t.length;++n){if("object"!=typeof t[n])throw Error("Received a non-object value when an object was expected.");if("undefined"==typeof t[n][e])throw Error("Object "+JSON.stringify(t[n])+" has no property "+String(e)+".");r.push(t[n][e])}return r}function P(t){var e=M(t);switch(e){case c:return[B(t)];case d:var r={};return Object.getOwnPropertyNames(t).forEach(function(e){r[e]=P(t[e])}),r;case I:return l;default:return e}}function k(t,e){-1===t.indexOf(e)&&t.push(e)}function _(e){return m(t(e)).parseSI().parseOLI().parseValue()}function W(t){return A(t).writeSI().writeOLI().writeData()["export"]()}function G(t){return this instanceof G?void(this.spec=t):new G(t)}t.concat=function(e){return t(e.reduce(function(t,e){return t+e.buffer},""))},t.fromString=function(e){for(var r=t(),n=0;e[n];)r.writeUInt8(e.charCodeAt(n),n),n++;return r},t.prototype={writeUInt8:function(t,e){return t=+t,e===this.buffer.length||-1===e?this.buffer+=String.fromCharCode(t):this.buffer=this.buffer.substr(0,e)+String.fromCharCode(t)+this.buffer.substr(e+1),e+1},writeInt8:function(t,e){return t=+t,t=0>t?N(-t,8):t,e===this.buffer.length||-1===e?this.buffer+=String.fromCharCode(t):this.buffer=this.buffer.substr(0,e)+String.fromCharCode(t)+this.buffer.substr(e+1),e+1},writeUInt16LE:function(t,e){return t=+t,e===this.buffer.length||-1===e?(this.buffer+=String.fromCharCode(255&t),this.buffer+=String.fromCharCode(t>>>8)):this.buffer=this.buffer.substr(0,e)+String.fromCharCode(255&t)+String.fromCharCode(t>>>8)+this.buffer.substr(e+2),e+2},writeInt16LE:function(t,e){return t=+t,t=0>t?N(-t,16):t,this.writeUInt16LE(t,e)},writeUInt32LE:function(t,e){t=+t,e===this.buffer.length||-1===e?this.buffer+=String.fromCharCode(255&t)+String.fromCharCode(t>>>8&255)+String.fromCharCode(t>>>16&255)+String.fromCharCode(t>>>24&255):this.buffer=this.buffer.substr(0,e)+String.fromCharCode(255&t)+String.fromCharCode(t>>>8&255)+String.fromCharCode(t>>>16&255)+String.fromCharCode(t>>>24&255)+this.buffer.substr(e+4)},writeInt32LE:function(t,e){return t=+t,t=0>t?N(-t,32):t,this.writeUInt32LE(t,e)},writeFloatLE:function(t,e){var r,n,i=127,s=[];r=0>t?1:0,t=Math.abs(t),n=Math.log(t)/Math.LN2,n=0>n?Math.ceil(n):Math.floor(n),t*=Math.pow(2,-n+23),i+=n,t=Math.round(t),t&=8388607,s.push(r<<7),s[0]|=(254&i)>>1,s.push((1&i)<<7),s[1]|=t>>16&127,s.push(t>>8&255),s.push(255&t);for(var a=3;a>=0;--a)this.writeUInt8(s[a],e+(3-a));return e+4},writeDoubleLE:function(t,e){var r,n,i=1023;r=0>t?1:0,t=Math.abs(t),n=Math.log(t)/Math.LN2,n=0>n?Math.ceil(n):Math.floor(n),t*=Math.pow(2,-n+52),i+=n,t=Math.round(t),t=parseInt(t.toString(2).substr(1),2);var s=[];s.push(r<<7),s[0]|=i>>4,s.push((15&i)<<4),s[1]|=15&Math.floor(t*Math.pow(2,-48));for(var a=40,h=0;6>h;++h)s.push(255&Math.floor(t*Math.pow(2,-a))),a-=8;for(h=7;h>=0;--h)this.writeUInt8(s[h],e+(7-h));return e+8},readUInt8:function(t){return t>>>=0,this.buffer.charCodeAt(t)},readInt8:function(t){t>>>=0;var e=this.buffer.charCodeAt(t);return 128&e?-N(e,8):e},readUInt16LE:function(t){return t>>>=0,this.buffer.charCodeAt(t)|this.buffer.charCodeAt(t+1)<<8},readInt16LE:function(t){var e=this.readUInt16LE(t);return 32768&e?-N(e,16):e},readUInt32LE:function(t){return t>>>=0,this.buffer.charCodeAt(t)|this.buffer.charCodeAt(t+1)<<8|this.buffer.charCodeAt(t+2)<<16|this.buffer.charCodeAt(t+3)<<24},readInt32LE:function(t){var e=this.readUInt32LE(t);return 0>e?e:2147483648&e?-N(e,32):e},readFloatLE:function(t){for(var e=[],r=3;r>=0;--r)e.push(this.readUInt8(t+r));var n=(128&e[0])>>7,i=(127&e[0])<<1|(128&e[1])>>7,s=0;e[1]&=127;for(var r=0;2>=r;++r)s|=e[r+1]*Math.pow(2,8*(2-r));return s|=8388608,(1===n?-s:s)*Math.pow(2,i-150)},readDoubleLE:function(t){for(var e=[],r=7;r>=0;--r)e.push(this.readUInt8(t+r));var n=(128&e[0])>>7,i=(127&e[0])<<4|(240&e[1])>>4,s=0;e[1]&=15;for(var r=0;6>=r;++r)s+=e[r+1]*Math.pow(2,8*(6-r));return s+=4503599627370496,(1===n?-s:s)*Math.pow(2,i-1075)}},U.prototype={exhausted:function(){return i>=this.buffer.length},readUInt8:function(){return this.i++,this.buffer.readUInt8(this.i-1)},readInt8:function(){return this.i++,this.buffer.readInt8(this.i-1)},readUInt16:function(){return this.i+=2,this.buffer.readUInt16LE(this.i-2)},readInt16:function(){return this.i+=2,this.buffer.readInt16LE(this.i-2)},readUInt32:function(){return this.i+=4,this.buffer.readUInt32LE(this.i-4)},readInt32:function(){return this.i+=4,this.buffer.readInt32LE(this.i-4)},readInt64:function(){return this.i+=8,this.buffer.readInt64LE(this.i-8)},readFloat:function(){return this.i+=4,this.buffer.readFloatLE(this.i-4)},readDouble:function(){return this.i+=8,this.buffer.readDoubleLE(this.i-8)},readValue:function(t){return t===n?this.readUInt8():t===(n|r)?this.readInt8():t===s?this.readUInt16():t===(s|r)?this.readInt16():t===a?this.readUInt32():t===(a|r)?this.readInt32():t===h?this.readFloat():t===u?this.readDouble():void 0}},m.prototype={readString:function(){for(var t="",e=this.buffer.readUInt8(),r=this.buffer.readValue(e),n=0;r>n;)t+=String.fromCharCode(this.buffer.readUInt8()),++n;return t},parseSI:function(){if(this.state&e)throw Error("Already parsed string index.");var t;switch(this.stringIndexType=this.buffer.readUInt8(),this.stringIndexType){case n:case s:case a:t=this.buffer.readValue(this.stringIndexType);break;case O:t=0;break;default:throw Error("Invalid LEON.")}for(var r=0;t>r;++r)this.stringIndex.push(this.readString());return this.state|=e,this},parseOLI:function(){if(this.state&e||this.parseSI(),!this.stringIndex.length)return this;var t,r,i,h;switch(this.OLItype=this.buffer.readUInt8(),this.OLItype){case n:case s:case a:t=this.buffer.readValue(this.OLItype);break;case O:return this;default:throw Error("Invalid LEON.")}for(i=0;t>i;++i)for(this.objectLayoutIndex.push([]),r=this.buffer.readValue(this.buffer.readUInt8()),h=0;r>h;++h)this.objectLayoutIndex[i].push(this.buffer.readValue(this.stringIndexType));return this},parseValueWithSpec:function(t){var e,r,n,i,s;if("undefined"==typeof t&&(t=this.spec),t===p)return e=this.readString();if("object"==typeof t){if(t===w)return e=this.parseValue(t);if(Array.isArray(t)){if(0===t.length)return this.parseValue(c);for(t=t[0],s=this.buffer.readUInt8(),n=this.buffer.readValue(s),e=[],r=0;n>r;++r)e.push(this.parseValueWithSpec(t));return e}for(e={},i=Object.getOwnPropertyNames(t),i.sort(function(t,e){return t>e}),r=0;r<i.length;++r)e[i[r]]=this.parseValueWithSpec(t[i[r]]);return e}return t===(l&I)?this.parseValue():this.parseValue(t)},parseValue:function(t){"undefined"==typeof t&&(t=this.buffer.readUInt8());var e,r,i,s;if(d>t)return this.buffer.readValue(t);switch(t){case c:for(t=this.buffer.readUInt8(),e=this.buffer.readValue(t),i=[],r=0;e>r;++r)i.push(this.parseValue());return i;case d:for(s=this.objectLayoutIndex[this.buffer.readValue(this.OLItype)],i={},r=0;r<s.length;++r)i[this.stringIndex[s[r]]]=this.parseValue();break;case p:return this.stringIndex[this.buffer.readValue(this.stringIndexType)];case g:return void 0;case l:return!0;case I:return!1;case b:return null;case L:return 0/0;case v:return Number.NEGATIVE_INFINITY;case S:return Number.POSITIVE_INFINITY;case w:return new Date(this.buffer.readValue(u));case y:e=this.buffer.readValue(this.buffer.readUInt8());try{i=new Buffer(e)}catch(a){try{i=StringBuffer()}catch(a){throw Error("LEON object contains a Buffer but StringBuffer has not been loaded.")}}for(r=0;e>r;++r)i.writeUInt8(this.buffer.readValue(n),r);return i;case E:return RegExp(this.readString(),this.readString());default:throw Error("Invalid LEON.")}return i}},A.prototype={append:function(e){this.buffer=t.concat([this.buffer,e])},writeData:function(){return"undefined"!=typeof this.spec?this.writeValueWithSpec(this.payload):this.writeValue(this.payload,M(this.payload)),this},"export":function(){return this.buffer.buffer},writeValueWithSpec:function(t,e){var r,n;if("undefined"==typeof e&&(e=this.spec),"object"==typeof e)if(Array.isArray(e))for(this.writeValue(t.length,M(t.length)),n=0;n<t.length;++n)this.writeValueWithSpec(t[n],e[0]);else if("[object Date]"===toString.call(t))this.writeValue(t,w,!0);else for(r=Object.getOwnPropertyNames(e),r.sort(function(t,e){return t>e}),n=0;n<r.length;++n)this.writeValueWithSpec(t[r[n]],e[r[n]]);else e===(l&I)?this.writeValue(t,M(t),!0):this.writeValue(t,e,!0)},writeValue:function(e,i,O){var V,x,N,C,U,m=t();switch(m.writeUInt8(i,0),i){case g:case l:case I:case b:case L:case v:case S:return this.append(m),1;case p:return O||this.append(m),this.stringIndex?(this.writeValue(this.stringIndex.indexOf(e),this.stringIndexType,!0),2):(this.writeString(e),2+e.length);case r:return O||this.append(m),V=t(),V.writeInt8(e,0),this.append(V),2;case n:return O||this.append(m),V=t(),V.writeUInt8(e,0),this.append(V),2;case f:return O||this.append(m),V=t(),V.writeInt16LE(e,0),this.append(V),3;case s:return O||this.append(m),V=t(),V.writeUInt16LE(e,0),this.append(V),3;case o:return O||this.append(m),V=t(),V.writeInt32LE(e,0),this.append(V),5;case a:return O||this.append(m),V=t(),V.writeUInt32LE(e,0),this.append(V),5;case h:return O||this.append(m),V=t(),V.writeFloatLE(e,0),this.append(V),5;case u:return O||this.append(m),V=t(),V.writeDoubleLE(e,0),this.append(V),9;case c:for(O||this.append(m),this.writeValue(e.length,M(e.length)),x=0;x<e.length;++x)this.writeValue(e[x],M(e[x]));break;case d:for(O||this.append(m),C=T(e,this.stringIndex,this.OLI),O||this.writeValue(C,this.OLItype,!0),x=0;x<this.OLI[C].length;++x)N=e[this.stringIndex[this.OLI[C][x]]],this.writeValue(N,M(N));break;case w:O||this.append(m),this.writeValue(e.valueOf(),u,!0);break;case y:for(O||this.append(m),this.writeValue(e.length,M(e.length)),x=0;x<e.length;++x)this.writeValue(e[x],n,!0);break;case E:return O||this.append(m),U=j(e),this.writeString(U[0]),this.writeString(U[1]),U.reduce(function(t,e){return t+e.length+1},0)}},writeString:function(t){this.writeValue(t.length,M(t.length));for(var e=0;e<t.length;++e)this.writeValue(t.charCodeAt(e),n,!0)},writeOLI:function(t){return this.stringIndex.length?(this.OLI=D(this.payload,this.stringIndex),this.OLI.length?(this.OLItype=M(this.OLI.length),this.writeValue(this.OLI.length,this.OLItype),this.OLI.forEach(function(t){var e=M(t.length);this.writeValue(t.length,e),t.forEach(function(t){this.writeValue(t,this.stringIndexType,!0)},this)},this),this):(this.writeValue(O,n,!0),this)):this},writeSI:function(){return this.stringIndex=F(this.payload),this.stringIndex.length?(this.stringIndexType=M(this.stringIndex.length),this.writeValue(this.stringIndex.length,this.stringIndexType),this.stringIndex.forEach(function(t){this.writeString(t)},this),this):(this.writeValue(O,n,!0),this)}},G.prototype={stringify:function(t){return A(t,this.spec).writeData()["export"]()},parse:function(e){return m(t(e),this.spec).parseValueWithSpec()}};var Y={};return Y.types=V,Y.parse=_,Y.stringify=W,Y.toTemplate=P,Y.Channel=G,Y}();"undefined"!=typeof exports?"undefined"!=typeof module&&module.exports&&(exports=module.exports=x):t.LEON=x}).call(this);