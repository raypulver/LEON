"use strict";(function(){function t(t){for(var e=Object.getOwnPropertyNames(U),r=0;r<e.length;++r)if(U[e[r]]===t)return e[r];throw TypeError(String(t)+" is not a valid type.")}function e(t,r){if("undefined"==typeof r){if("object"!=typeof t)throw TypeError("Argument must be an object");return e.bind(this,t)}if("object"!=typeof r)throw TypeError("Argument must be an object");return Object.getOwnPropertyNames(r).forEach(function(t){this[t]=r[t]},t),e.bind(this,t)}var r=this,n=(r.LEON,1),s=1,a=0,h=2,u=4,f=6,o=7,c=3,d=5,p=128,l=9,b=16,g=32,I=33,w=64,y=20,E=21,S=22,O=23,v=24,L=25,N=26,V=221,m=255,x=1,C={USE_INDEXING:x},U={CHAR:s|a,UNSIGNED_CHAR:a,SHORT:s|h,UNSIGNED_SHORT:h,INT:s|u,UNSIGNED_INT:u,FLOAT:f,DOUBLE:o,STRING:b,BOOLEAN:g&I,NULL:w,UNDEFINED:y,DATE:E,NAN:v,BUFFER:S,REGEXP:O,MINUS_INFINITY:N,INFINITY:L,DYNAMIC:V},j=function(){function r(t){return this instanceof r?void(this.buffer=t?t:""):new r(t)}function j(t,e,r){for(var n="",i=0;i<r-t.length;++i)n+=e;return n+=t}function A(t,e){var r,n,i,s;if(!e)return~t;if(e>31){for(r=t.toString(2),r=j(r,"0",e),n="",i=0;i<r.length;++i)n+="0"===r[i]?"1":"0";return s=parseInt(n,2),s+=1}return(t^M(e))+1}function M(t){return(1<<t)-1}function T(t){return this instanceof T?(this.buffer=t,void(this.i=0)):new T(t)}function D(t,e){return this instanceof D?(this.buffer=T(t),this.state=0,this.stringIndex=[],this.objectLayoutIndex=[],void(this.spec=e)):new D(t,e)}function P(t,e){var r;if("object"==typeof t){if(null===t)return w;if(Array.isArray(t))return p;if(r=toString.call(t),"[object Date]"===r)return E;if("[object RegExp]"===r)return O;try{if(Buffer.isBuffer(t))return S}catch(n){try{if(t instanceof StringBuffer)return S}catch(n){}}return l}if("function"==typeof t||"undefined"==typeof t)return y;if("boolean"==typeof t)return t?g:I;if("string"==typeof t)return b;if("number"==typeof t){if(t!==t)return v;if(t===Number.NEGATIVE_INFINITY)return N;if(t===Number.POSITIVE_INFINITY)return L;var i,c=0,d=t;return d%1||e?(d=Math.abs(t),i=Math.log(d)/Math.LN2,i=0>i?Math.ceil(i):Math.floor(i),c=103+i,0>c||c>255?o:(d*=Math.pow(2,-i+24),Math.floor(d)!=d?o:f)):0>d?Math.abs(d)<=128?s|a:Math.abs(d)<=32768?s|h:Math.abs(d)<=Math.pow(2,31)?s|u:o:256>d?a:65536>d?h:d<Math.pow(2,32)?u:o}}function F(t,e){return this instanceof F?(this.payload=t,this.buffer=r(),this.spec=e,void(this.state=0)):new F(t,e)}function R(t,e,r){for(var n,i,s,a=0,h=Object.getOwnPropertyNames(t).map(function(t){return e.indexOf(t)}).sort(function(t,e){return t-e});a<r.length;)if(s=!1,h.length===r[a].length){for(i=r[a].slice().sort(function(t,e){return t-e}),n=0;n<h.length;++n)if(h[n]!==i[n]){s=!0;break}if(!s)return a;++a}else++a}function B(t){return t=t.toString(),[t.substr(1,t.lastIndexOf("/")-1),t.substr(t.lastIndexOf("/")+1)]}function k(t,e,r,n){var i,s,a,h;if(r||(r=[]),void 0===n&&(n=t),"object"==typeof n&&!Buffer.isBuffer(n)&&"[object RegExp]"!==toString.call(n)&&"[object Date]"!==toString.call(n)&&null!==n)for(i=Object.getOwnPropertyNames(n),Array.isArray(n)||"[object Date]"===toString.call(n)||(h=[],i.forEach(function(t){h.push(e.indexOf(t))}),h.sort(function(t,e){return t-e}),function(t,e){var r;for(s=0;s<t.length;++s)if(r=!1,t[s].length===e.length){for(a=0;a<e.length;++a)if(e[a]!==t[s][a]){r=!0;break}if(!r)return!1}return!0}(r,h)&&r.push(h)),s=0;s<i.length;++s)k(t,e,r,n[i[s]]);return r}function W(t,e,r){e||(e=[]),void 0===r&&(r=t);var n,i;if("object"!=typeof r||"[object RegExp]"===toString.call(r)||"[object Date]"===toString.call(r)||Buffer.isBuffer(r))"string"==typeof r&&H(e,r);else for(n=Object.getOwnPropertyNames(r),Array.isArray(r)||n.forEach(function(t){H(e,t)}),i=0;i<n.length;++i)W(t,e,r[n[i]]);return e}function _(t){var e=P(t[0]);switch(e){case a:case s:case h:case c:case u:case d:case f:case o:for(var r=Math.abs(t[0]),n=t[0]%1!==0,i=t[0]<0?1:0,b=1;b<t.length;++b){if("number"!=typeof t[b])return V;Math.abs(t[b])>r&&(r=Math.abs(t[b])),t[b]%1!==0&&(n=!0),t[b]<0&&(i=1)}return P((i?-1:1)*r,n);case p:return[_(t.reduce(function(t,e){return t.concat(e)},[]))];case l:var w={};return Object.getOwnPropertyNames(t[0]).forEach(function(e){w[e]=_(G(t,e))}),w;default:e===I&&(e=g);for(var y,b=1;b<t.length;++b)if(y=P(t[b]),y===I&&(y=g),y!==e)return V;return e}}function G(t,e){for(var r=[],n=0;n<t.length;++n){if("object"!=typeof t[n])throw Error("Received a non-object value when an object was expected.");if("undefined"==typeof t[n][e])throw Error("Object "+JSON.stringify(t[n])+" has no property "+String(e)+".");r.push(t[n][e])}return r}function Y(t){var e=P(t);switch(e){case p:return[_(t)];case l:var r={};return Object.getOwnPropertyNames(t).forEach(function(e){r[e]=Y(t[e])}),r;case I:return g;default:return e}}function H(t,e){-1===t.indexOf(e)&&t.push(e)}function X(t,e){var n=D(r(t));return e&x&&n.parseSI().parseOLI(),n.parseValue()}function z(t,e){var r=F(t);return e&x&&r.writeSI().writeOLI(),r.writeData()["export"]()}function J(t){return/^[0-9]/.test(t)||/[^\w_]/.test(t)?!0:!1}function q(t,e){for(var r=0,n=Object.getOwnPropertyNames(t);r<n.length;++r)if(t[n[r]]===e)return!0;return!1}function K(t,e){var r;switch("undefined"==typeof e&&(e="{Template}"),typeof t){case"number":if(!q(U,t))throw Error(e+" is not a valid type constant.");break;case"function":throw Error(e+" is a function.");case"boolean":throw Error(e+" is a boolean.");case"undefined":throw Error(e+" is undefined. Did you misspell a type constant?");case"string":throw Error(e+" is a string.");case"object":if("[object Date]"===toString.call(t))throw Error(e+" is a Date object. Did you mean to supply LEON.DATE?");if("[object RegExp]"===toString.call(t))throw Error(e+" is a RegExp. Did you mean to supply LEON.REGEXP?");if(Array.isArray(t)){if(0===t.length)throw Error(e+" is an array with no elements, must have one.");if(t.length>1)throw Error(e+" is an array with more than one element. If you want to serialize an array of various types you must use LEON.DYNAMIC.");K(t[0],e+"[0]")}else for(var n=0,i=Object.getOwnPropertyNames(t);n<i.length;++n)r=J(t),K(t[i[n]],e+(r?"['"+i[n]+"']":"."+i[n]))}}function Q(t){return this instanceof Q?(K(t),void(this.spec=t)):new Q(t)}function Z(t,e){for(var r="",n=0;e>n;++n)r+=t;return r}function $(t,e){return J(t)?(e?"[32m":"")+"'"+t+"'"+(e?"[m":""):t}r.concat=function(t){return r(t.reduce(function(t,e){return t+e.buffer},""))},r.fromString=function(t){for(var e=r(),n=0;t[n];)e.writeUInt8(t.charCodeAt(n),n),n++;return e},r.prototype={writeUInt8:function(t,e){return t=+t,e===this.buffer.length||-1===e?this.buffer+=String.fromCharCode(t):this.buffer=this.buffer.substr(0,e)+String.fromCharCode(t)+this.buffer.substr(e+1),e+1},writeInt8:function(t,e){return t=+t,t=0>t?A(-t,8):t,e===this.buffer.length||-1===e?this.buffer+=String.fromCharCode(t):this.buffer=this.buffer.substr(0,e)+String.fromCharCode(t)+this.buffer.substr(e+1),e+1},writeUInt16LE:function(t,e){return t=+t,e===this.buffer.length||-1===e?(this.buffer+=String.fromCharCode(255&t),this.buffer+=String.fromCharCode(t>>>8)):this.buffer=this.buffer.substr(0,e)+String.fromCharCode(255&t)+String.fromCharCode(t>>>8)+this.buffer.substr(e+2),e+2},writeInt16LE:function(t,e){return t=+t,t=0>t?A(-t,16):t,this.writeUInt16LE(t,e)},writeUInt32LE:function(t,e){t=+t,e===this.buffer.length||-1===e?this.buffer+=String.fromCharCode(255&t)+String.fromCharCode(t>>>8&255)+String.fromCharCode(t>>>16&255)+String.fromCharCode(t>>>24&255):this.buffer=this.buffer.substr(0,e)+String.fromCharCode(255&t)+String.fromCharCode(t>>>8&255)+String.fromCharCode(t>>>16&255)+String.fromCharCode(t>>>24&255)+this.buffer.substr(e+4)},writeInt32LE:function(t,e){return t=+t,t=0>t?A(-t,32):t,this.writeUInt32LE(t,e)},writeFloatLE:function(t,e){var r,n,i=127,s=[];r=0>t?1:0,t=Math.abs(t),n=Math.log(t)/Math.LN2,n=0>n?Math.ceil(n):Math.floor(n),t*=Math.pow(2,-n+23),i+=n,t=Math.round(t),t&=8388607,s.push(r<<7),s[0]|=(254&i)>>1,s.push((1&i)<<7),s[1]|=t>>16&127,s.push(t>>8&255),s.push(255&t);for(var a=3;a>=0;--a)this.writeUInt8(s[a],e+(3-a));return e+4},writeDoubleLE:function(t,e){var r,n,i=1023;r=0>t?1:0,t=Math.abs(t),n=Math.log(t)/Math.LN2,n=0>n?Math.ceil(n):Math.floor(n),t*=Math.pow(2,-n+52),i+=n,t=Math.round(t),t=parseInt(t.toString(2).substr(1),2);var s=[];s.push(r<<7),s[0]|=i>>4,s.push((15&i)<<4),s[1]|=15&Math.floor(t*Math.pow(2,-48));for(var a=40,h=0;6>h;++h)s.push(255&Math.floor(t*Math.pow(2,-a))),a-=8;for(h=7;h>=0;--h)this.writeUInt8(s[h],e+(7-h));return e+8},readUInt8:function(t){return t>>>=0,this.buffer.charCodeAt(t)},readInt8:function(t){t>>>=0;var e=this.buffer.charCodeAt(t);return 128&e?-A(e,8):e},readUInt16LE:function(t){return t>>>=0,this.buffer.charCodeAt(t)|this.buffer.charCodeAt(t+1)<<8},readInt16LE:function(t){var e=this.readUInt16LE(t);return 32768&e?-A(e,16):e},readUInt32LE:function(t){return t>>>=0,this.buffer.charCodeAt(t)|this.buffer.charCodeAt(t+1)<<8|this.buffer.charCodeAt(t+2)<<16|this.buffer.charCodeAt(t+3)<<24},readInt32LE:function(t){var e=this.readUInt32LE(t);return 0>e?e:2147483648&e?-A(e,32):e},readFloatLE:function(t){for(var e=[],r=3;r>=0;--r)e.push(this.readUInt8(t+r));var n=(128&e[0])>>7,i=(127&e[0])<<1|(128&e[1])>>7,s=0;e[1]&=127;for(var r=0;2>=r;++r)s|=e[r+1]*Math.pow(2,8*(2-r));return s|=8388608,(1===n?-s:s)*Math.pow(2,i-150)},readDoubleLE:function(t){for(var e=[],r=7;r>=0;--r)e.push(this.readUInt8(t+r));var n=(128&e[0])>>7,i=(127&e[0])<<4|(240&e[1])>>4,s=0;e[1]&=15;for(var r=0;6>=r;++r)s+=e[r+1]*Math.pow(2,8*(6-r));return s+=4503599627370496,(1===n?-s:s)*Math.pow(2,i-1075)}},T.prototype={exhausted:function(){return i>=this.buffer.length},readUInt8:function(){return this.i++,this.buffer.readUInt8(this.i-1)},readInt8:function(){return this.i++,this.buffer.readInt8(this.i-1)},readUInt16:function(){return this.i+=2,this.buffer.readUInt16LE(this.i-2)},readInt16:function(){return this.i+=2,this.buffer.readInt16LE(this.i-2)},readUInt32:function(){return this.i+=4,this.buffer.readUInt32LE(this.i-4)},readInt32:function(){return this.i+=4,this.buffer.readInt32LE(this.i-4)},readInt64:function(){return this.i+=8,this.buffer.readInt64LE(this.i-8)},readFloat:function(){return this.i+=4,this.buffer.readFloatLE(this.i-4)},readDouble:function(){return this.i+=8,this.buffer.readDoubleLE(this.i-8)},readValue:function(t){return t===a?this.readUInt8():t===(a|s)?this.readInt8():t===h?this.readUInt16():t===(h|s)?this.readInt16():t===u?this.readUInt32():t===(u|s)?this.readInt32():t===f?this.readFloat():t===o?this.readDouble():void 0}},D.prototype={readString:function(){for(var t="",e=this.buffer.readUInt8(),r=this.buffer.readValue(e),n=0;r>n;)t+=String.fromCharCode(this.buffer.readUInt8()),++n;return t},parseSI:function(){if(this.state&n)throw Error("Already parsed string index.");var t;switch(this.stringIndexType=this.buffer.readUInt8(),this.stringIndexType){case a:case h:case u:t=this.buffer.readValue(this.stringIndexType);break;case m:t=0;break;default:throw Error("Invalid LEON.")}for(var e=0;t>e;++e)this.stringIndex.push(this.readString());return this.state|=n,this},parseOLI:function(){if(this.state&n||this.parseSI(),!this.stringIndex.length)return this;var t,e,r,i;switch(this.OLItype=this.buffer.readUInt8(),this.OLItype){case a:case h:case u:t=this.buffer.readValue(this.OLItype);break;case m:return this;default:throw Error("Invalid LEON.")}for(r=0;t>r;++r)for(this.objectLayoutIndex.push([]),e=this.buffer.readValue(this.buffer.readUInt8()),i=0;e>i;++i)this.objectLayoutIndex[r].push(this.buffer.readValue(this.stringIndexType));return this},parseValueWithSpec:function(t){var e,r,n,i,s;if("undefined"==typeof t&&(t=this.spec),t===b)return e=this.readString();if(t===V)return this.parseValue();if("object"==typeof t){if(Array.isArray(t)){if(0===t.length)return this.parseValue(p);for(t=t[0],s=this.buffer.readUInt8(),n=this.buffer.readValue(s),e=[],r=0;n>r;++r)e.push(this.parseValueWithSpec(t));return e}for(e={},i=Object.getOwnPropertyNames(t),i.sort(function(t,e){return t>e}),r=0;r<i.length;++r)e[i[r]]=this.parseValueWithSpec(t[i[r]]);return e}return t===(g&I)?this.parseValue():this.parseValue(t)},parseValue:function(t){"undefined"==typeof t&&(t=this.buffer.readUInt8());var e,r,i,s,h;if(l>t)return this.buffer.readValue(t);switch(t){case p:for(t=this.buffer.readUInt8(),e=this.buffer.readValue(t),i=[],r=0;e>r;++r)i.push(this.parseValue());return i;case l:if(i={},this.state&n)for(s=this.objectLayoutIndex[this.buffer.readValue(this.OLItype)],r=0;r<s.length;++r)i[this.stringIndex[s[r]]]=this.parseValue();else for(e=this.buffer.readValue(this.buffer.readUInt8()),r=0;e>r;++r)h=this.readString(),i[h]=this.parseValue();break;case b:return this.state&n?this.stringIndex[this.buffer.readValue(this.stringIndexType)]:this.readString();case y:return void 0;case g:return!0;case I:return!1;case w:return null;case v:return 0/0;case N:return Number.NEGATIVE_INFINITY;case L:return Number.POSITIVE_INFINITY;case E:return new Date(this.buffer.readValue(o));case S:e=this.buffer.readValue(this.buffer.readUInt8());try{i=new Buffer(e)}catch(u){try{i=StringBuffer()}catch(u){throw Error("LEON object contains a Buffer but StringBuffer has not been loaded.")}}for(r=0;e>r;++r)i.writeUInt8(this.buffer.readValue(a),r);return i;case O:return RegExp(this.readString(),this.readString());default:throw Error("Invalid LEON.")}return i}},F.prototype={append:function(t){this.buffer=r.concat([this.buffer,t])},writeData:function(){return"undefined"!=typeof this.spec?this.writeValueWithSpec(this.payload):this.writeValue(this.payload,P(this.payload)),this},"export":function(){return this.buffer.buffer},writeValueWithSpec:function(t,e){var r,n,i=typeof t;if("undefined"==typeof e&&(e=this.spec),"object"==typeof e)if(Array.isArray(e)){if(!Array.isArray(t))throw TypeError("Was expecting an array but instead got a "+i+".");for(this.writeValue(t.length,P(t.length)),n=0;n<t.length;++n)this.writeValueWithSpec(t[n],e[0])}else if("[object Date]"===toString.call(t))this.writeValue(t,E,!0);else{if("object"!=typeof t)throw TypeError("Was expecting an object but instead got a "+i+".");for(r=Object.getOwnPropertyNames(e),r.sort(function(t,e){return t>e}),n=0;n<r.length;++n)this.writeValueWithSpec(t[r[n]],e[r[n]])}else e===V?this.writeValue(t,P(t)):e===(g&I)?this.writeValue(t,P(t),!0):this.writeValue(t,e,!0)},writeValue:function(t,e,i){var V,m,x,C,U,j=r();switch(j.writeUInt8(e,0),e){case y:case g:case I:case w:case v:case N:case L:return this.append(j),1;case b:return i||this.append(j),this.state&n&&this.stringIndex?(this.writeValue(this.stringIndex.indexOf(t),this.stringIndexType,!0),2):(this.writeString(t),2+t.length);case s:return i||this.append(j),V=r(),V.writeInt8(t,0),this.append(V),2;case a:return i||this.append(j),V=r(),V.writeUInt8(t,0),this.append(V),2;case c:return i||this.append(j),V=r(),V.writeInt16LE(t,0),this.append(V),3;case h:return i||this.append(j),V=r(),V.writeUInt16LE(t,0),this.append(V),3;case d:return i||this.append(j),V=r(),V.writeInt32LE(t,0),this.append(V),5;case u:return i||this.append(j),V=r(),V.writeUInt32LE(t,0),this.append(V),5;case f:return i||this.append(j),V=r(),V.writeFloatLE(t,0),this.append(V),5;case o:return i||this.append(j),V=r(),V.writeDoubleLE(t,0),this.append(V),9;case p:for(i||this.append(j),this.writeValue(t.length,P(t.length)),m=0;m<t.length;++m)this.writeValue(t[m],P(t[m]));break;case l:if(i||this.append(j),this.state&n)for(C=R(t,this.stringIndex,this.OLI),i||this.writeValue(C,this.OLItype,!0),m=0;m<this.OLI[C].length;++m)x=t[this.stringIndex[this.OLI[C][m]]],this.writeValue(x,P(x));else for(C=Object.getOwnPropertyNames(t),this.writeValue(C.length,P(C.length)),m=0;m<C.length;++m)this.writeString(C[m]),this.writeValue(t[C[m]],P(t[C[m]]));break;case E:i||this.append(j),this.writeValue(t.valueOf(),o,!0);break;case S:for(i||this.append(j),this.writeValue(t.length,P(t.length)),m=0;m<t.length;++m)this.writeValue(t[m],a,!0);break;case O:return i||this.append(j),U=B(t),this.writeString(U[0]),this.writeString(U[1]),U.reduce(function(t,e){return t+e.length+1},0)}},writeString:function(t){this.writeValue(t.length,P(t.length));for(var e=0;e<t.length;++e)this.writeValue(t.charCodeAt(e),a,!0)},writeOLI:function(t){return this.stringIndex.length?(this.OLI=k(this.payload,this.stringIndex),this.OLI.length?(this.OLItype=P(this.OLI.length),this.writeValue(this.OLI.length,this.OLItype),this.OLI.forEach(function(t){var e=P(t.length);this.writeValue(t.length,e),t.forEach(function(t){this.writeValue(t,this.stringIndexType,!0)},this)},this),this):(this.writeValue(m,a,!0),this)):this},writeSI:function(){return this.stringIndex=W(this.payload),this.stringIndex.length?(this.stringIndexType=P(this.stringIndex.length),this.writeValue(this.stringIndex.length,this.stringIndexType),this.stringIndex.forEach(function(t){this.writeString(t)},this),this.state|=n,this):(this.state|=n,this.writeValue(m,a,!0),this)}},Q.prototype={inspect:function(e,r,n,i,s,a){var h="",u=!1;"undefined"==typeof r&&(r={colors:!1}),"undefined"==typeof a&&(a={}),"undefined"==typeof s&&(h+="{[Channel] ",s=!1,u=!0);var f,o;if("undefined"==typeof n&&(i=0),"undefined"==typeof n&&(n=this.spec),"object"==typeof n)if(Array.isArray(n))h+="["+this.inspect(e,r,n[0],i,s,a)+"]";else{for(a.flag=!0,h+="{\n",f=Object.getOwnPropertyNames(n),o=0;o<f.length;++o)h+=Z("  ",i+1)+$(f[o],r.colors)+": "+this.inspect(e,r,n[f[o]],i+1,s,a)+(f.length-1===o?"":",")+"\n";h+=Z("  ",i)+"}"}else h+=t(n);return u&&(h+="}"),h},stringify:function(t){return F(t,this.spec).writeData()["export"]()},parse:function(t){return D(r(t),this.spec).parseValueWithSpec()}};var tt={};return e(tt)(U)(C),tt.parse=X,tt.stringify=z,tt.toTemplate=Y,tt.Channel=Q,tt}();"undefined"!=typeof exports?"undefined"!=typeof module&&module.exports&&(exports=module.exports=j):r.LEON=j}).call(this);