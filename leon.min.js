"use strict";(function(){function t(t){var e=Object.create(null);return Object.keys(t).forEach(function(r){e[r]=t[r]}),e}function e(t){for(var e=Object.getOwnPropertyNames(B),r=0;r<e.length;++r)if(B[e[r]]===t)return e[r];throw TypeError(String(t)+" is not a valid type.")}function r(t,e){if("undefined"==typeof e){if("object"!=typeof t)throw TypeError("Argument must be an object");return r.bind(this,t)}if("object"!=typeof e)throw TypeError("Argument must be an object");return Object.keys(e).forEach(function(t){this[t]=e[t]},t),r.bind(this,t)}function i(t,e){return e>=32?-t:((1<<e)-1^t)+1}var n=this,s=n.LEON,a=65536,h=1,u=1,f=0,o=2,c=4,l=6,d=7,p=3,b=5,g=128,I=9,y=16,w=17,E=32,U=33,v=64,L=20,A=21,O=22,V=23,N=24,S=25,x=26,j=221,m=255,T=1,D=t({USE_INDEXING:T}),B=t({CHAR:u|f,UNSIGNED_CHAR:f,SHORT:u|o,UNSIGNED_SHORT:o,INT:u|c,UNSIGNED_INT:c,FLOAT:l,DOUBLE:d,STRING:y,UTF16STRING:w,BOOLEAN:E&U,NULL:v,UNDEFINED:L,DATE:A,NAN:N,BUFFER:O,REGEXP:V,MINUS_INFINITY:x,INFINITY:S,DYNAMIC:j}),F=function(){try{return new Buffer(4),!0}catch(t){return!1}}.call(n),_=function(){var t=new ArrayBuffer(2),e=new Uint8Array(t),r=new Uint16Array(t);return r[0]=1,!!e[0]}(),R=(function(){var t=new ArrayBuffer(2),e=new DataView(t);return e.setUint16(0,258),2===e.getUint8(0)}(),function(){var t=new ArrayBuffer(2),e=new DataView(t);return e.setUint8(0,1),e.setUint8(1,2),513!==e.getUint16(0,!0)?!1:258!==e.getUint16(0,!1)?!1:(e.setUint16(0,258,!0),2!==e.getUint8(0)?!1:1!==e.getUint8(1)?!1:!0)}(),new ArrayBuffer(4)),P=new Uint8Array(R),C=new Float32Array(R),k=new ArrayBuffer(8),M=new Uint8Array(k),G=new Float64Array(k),W=function(){function t(e){if(!(this instanceof t))return new t(e);if("undefined"==typeof e&&(e=a),e instanceof ArrayBuffer)this.buffer=e;else if(F&&Buffer.isBuffer(e)){var r=e;e=new ArrayBuffer(r.length);for(var i=new Uint8Array(e),n=0;n<r.length;++n)i[n]=r[n];this.buffer=e}else this.buffer=new ArrayBuffer(e);this.uchars=new Uint8Array(this.buffer),this.chars=new Int8Array(this.buffer),ht.call(this),at.call(this)}function n(t){return this instanceof n?(this.buffer=t,this.i=0,void ut.call(this)):new n(t)}function R(t,e){return this instanceof R?(this.buffer=n(t),this.state=0,this.stringIndex=[],this.objectLayoutIndex=[],this.spec=e,void ft.call(this)):new R(t,e)}function k(t,e){var r;if("object"==typeof t){if(null===t)return v;if(Array.isArray(t))return g;if(r=toString.call(t),"[object Date]"===r)return A;if("[object RegExp]"===r)return V;try{if(Buffer.isBuffer(t))return O;if(t instanceof ArrayBuffer)return O}catch(i){if(t instanceof ArrayBuffer)return O}return I}return"function"==typeof t||"undefined"==typeof t?L:"boolean"==typeof t?t?E:U:"string"==typeof t?[].map.call(t,function(t){return t.charCodeAt(0)}).some(function(t){return t>255})?w:y:"number"==typeof t?t!==t?N:t===Number.NEGATIVE_INFINITY?x:t===Number.POSITIVE_INFINITY?S:t%1||e?(C[0]=t,C[0]===t?l:d):0>t?Math.abs(t)<=128?u|f:Math.abs(t)<=32768?u|o:Math.abs(t)<=Math.pow(2,31)?u|c:d:256>t?f:65536>t?o:t<Math.pow(2,32)?c:d:void 0}function W(e,r){return this instanceof W?(this.payload=e,this.buffer=t(),this.spec=r,this.state=0,this.i=0,void ot.call(this)):new W(e,r)}function Y(t,e,r){for(var i,n,s,a=0,h=Object.getOwnPropertyNames(t).map(function(t){return e.indexOf(t)}).sort(function(t,e){return t-e});a<r.length;)if(s=!1,h.length===r[a].length){for(n=r[a].slice().sort(function(t,e){return t-e}),i=0;i<h.length;++i)if(h[i]!==n[i]){s=!0;break}if(!s)return a;++a}else++a}function H(t){return t=t.toString(),[t.substr(1,t.lastIndexOf("/")-1),t.substr(t.lastIndexOf("/")+1)]}function X(t,e,r,i){var n,s,a,h;if(r||(r=[]),void 0===i&&(i=t),"object"==typeof i&&!Buffer.isBuffer(i)&&"[object RegExp]"!==toString.call(i)&&"[object Date]"!==toString.call(i)&&null!==i)for(n=Object.getOwnPropertyNames(i),Array.isArray(i)||"[object Date]"===toString.call(i)||(h=[],n.forEach(function(t){h.push(e.indexOf(t))}),h.sort(function(t,e){return t-e}),function(t,e){var r;for(s=0;s<t.length;++s)if(r=!1,t[s].length===e.length){for(a=0;a<e.length;++a)if(e[a]!==t[s][a]){r=!0;break}if(!r)return!1}return!0}(r,h)&&r.push(h)),s=0;s<n.length;++s)X(t,e,r,i[n[s]]);return r}function z(t,e,r){e||(e=[]),void 0===r&&(r=t);var i,n;if("object"!=typeof r||"[object RegExp]"===toString.call(r)||"[object Date]"===toString.call(r)||Buffer.isBuffer(r))"string"==typeof r&&K(e,r);else for(i=Object.getOwnPropertyNames(r),Array.isArray(r)||i.forEach(function(t){K(e,t)}),n=0;n<i.length;++n)z(t,e,r[i[n]]);return e}function J(t){var e=k(t[0]);switch(e){case f:case u:case o:case p:case c:case b:case l:case d:for(var r=Math.abs(t[0]),i=t[0]%1!==0,n=t[0]<0?1:0,s=1;s<t.length;++s){if("number"!=typeof t[s])return j;Math.abs(t[s])>r&&(r=Math.abs(t[s])),t[s]%1!==0&&(i=!0),t[s]<0&&(n=1)}return k((n?-1:1)*r,i);case g:return[J(t.reduce(function(t,e){return t.concat(e)},[]))];case I:var a={};return Object.getOwnPropertyNames(t[0]).forEach(function(e){a[e]=J($(t,e))}),a;default:e===U&&(e=E);for(var h,s=1;s<t.length;++s)if(h=k(t[s]),h===U&&(h=E),h!==e)return j;return e}}function $(t,e){for(var r=[],i=0;i<t.length;++i){if("object"!=typeof t[i])throw Error("Received a non-object value when an object was expected.");if("undefined"==typeof t[i][e])throw Error("Object "+JSON.stringify(t[i])+" has no property "+String(e)+".");r.push(t[i][e])}return r}function q(t){var e=k(t);switch(e){case g:return[J(t)];case I:var r={};return Object.getOwnPropertyNames(t).forEach(function(e){r[e]=q(t[e])}),r;case U:return E;default:return e}}function K(t,e){-1===t.indexOf(e)&&t.push(e)}function Q(e,r){var i=R(t(e));return r&T&&i.parseSI().parseOLI(),i.parseValue()}function Z(t,e){var r=W(t);return e&T&&r.writeSI().writeOLI(),r.writeData()["export"]()}function tt(t){return/^[0-9]/.test(t)||/[^\w_]/.test(t)?!0:!1}function et(t,e){for(var r=0,i=Object.getOwnPropertyNames(t);r<i.length;++r)if(t[i[r]]===e)return!0;return!1}function rt(t,e){var r;switch("undefined"==typeof e&&(e="{Template}"),typeof t){case"number":if(!et(B,t))throw Error(e+" is not a valid type constant.");break;case"function":throw Error(e+" is a function.");case"boolean":throw Error(e+" is a boolean.");case"undefined":throw Error(e+" is undefined. Did you misspell a type constant?");case"string":throw Error(e+" is a string.");case"object":if("[object Date]"===toString.call(t))throw Error(e+" is a Date object. Did you mean to supply LEON.DATE?");if("[object RegExp]"===toString.call(t))throw Error(e+" is a RegExp. Did you mean to supply LEON.REGEXP?");if(Array.isArray(t)){if(0===t.length)throw Error(e+" is an array with no elements, must have one.");if(t.length>1)throw Error(e+" is an array with more than one element. If you want to serialize an array of various types you must use LEON.DYNAMIC.");rt(t[0],e+"[0]")}else for(var i=0,n=Object.getOwnPropertyNames(t);i<n.length;++i)r=tt(t),rt(t[n[i]],e+(r?"['"+n[i]+"']":"."+n[i]))}}function it(t){return this instanceof it?(rt(t),this.spec=t,void(this.sorted=function e(t){if("object"==typeof t){if(Array.isArray(t)){var r=[];return r.push(e(t[0])),r}var r=[],i=Object.getOwnPropertyNames(t);i.sort(function(t,e){return t>e});for(var n=0;n<i.length;++n)r.push(i[n]),r.push(e(t[i[n]]));return r.object=!0,r}return t}(t))):new it(t)}function nt(t,e){for(var r="",i=0;e>i;++i)r+=t;return r}function st(t,e){return tt(t)?(e?"[32m":"")+"'"+t+"'"+(e?"[m":""):t}var at=function(){function t(t){"undefined"==typeof t&&(t=this.buffer.byteLength<<1);var e=this.buffer;this.buffer=new ArrayBuffer(t);var r=new Uint8Array(e),i=new Uint8Array(this.buffer);return i.set(r,0),this.uchars=new Uint8Array(this.buffer),this.chars=new Int8Array(this.buffer),this}return function(){this._realloc=t}}(),ht=function(){function t(t,e){return e>=this.buffer.byteLength&&this._realloc(),this.uchars[e]=t,this}function e(t,e){return e>=this.buffer.byteLength&&this._realloc(),this.chars[e]=t,this}function r(t,e){return e>=this.buffer.byteLength-1&&this._realloc(),this.uchars[e]=255&t,this.uchars[e+1]=t>>>8,this}function n(t,e){return 0>t&&(t=i(-t,16)),this.writeUInt16LE(t,e)}function s(t,e){return e>=this.buffer.byteLength-3&&this._realloc(),this.uchars[e]=255&t,this.uchars[e+1]=t>>>8&255,this.uchars[e+2]=t>>>16&255,this.uchars[e+3]=t>>>24,this}function a(t,e){return 0>t&&(t=i(-t,32)),this.writeUInt32LE(t,e)}function h(t,e){if(e>=this.buffer.byteLength-3&&this._realloc(),C[0]=t,_)return this.uchars.set(P,e),this;for(var r=P.length-1;r>=0;--r)this.uchars[e+(P.length-1-r)]=P[r];return this}function u(t,e){if(e>=this.buffer.byteLength-7&&this._realloc(),G[0]=t,_)return this.uchars.set(M,e),this;for(var r=M.length-1;r>=0;--r)this.uchars[e+(M.length-1-r)]=M[r];return this}function f(t){return this.uchars[t]}function o(t){return this.chars[t]}function c(t){return this.uchars[t+1]<<8|this.uchars[t]}function l(t){var e=this.readUInt16LE(t);return 32768&e?-i(e,16):e}function d(t){return this.uchars[t+3]<<24|this.uchars[t+2]<<16|this.uchars[t+1]<<8|this.uchars[t]}function p(t){var e=this.readUInt32LE(t);return 0>e?e:2147483648&e?-i(e,32):e}function b(t){if(_){for(var e=0;e<P.length;++e)P[e]=this.uchars[t+e];return C[0]}for(var e=P.length-1;e>=0;--e)P[P.length-1-e]=this.uchars[t+e];return C[0]}function g(t){if(_){for(var e=0;e<M.length;++e)M[e]=this.uchars[t+e];return G[0]}for(var e=M.length-1;e>=0;--e)M[M.length-1-e]=this.uchars[t+e];return G[0]}return function(){this.writeUInt8=t,this.writeInt8=e,this.writeUInt16LE=r,this.writeInt16LE=n,this.writeUInt32LE=s,this.writeInt32LE=a,this.writeFloatLE=h,this.writeDoubleLE=u,this.readUInt8=f,this.readInt8=o,this.readUInt16LE=c,this.readInt16LE=l,this.readUInt32LE=d,this.readInt32LE=p,this.readFloatLE=b,this.readDoubleLE=g}}();t.concat=function(e){return $StringBuffer(e.reduce(function(t,e){var r=new Uint8Array(t.buffer.byteLength+e.buffer.byteLength);return r.set(new Uint8Array(t.buffer),0),r.set(new Uint8Array(e.buffer),t.buffer.byteLength),r.buffer},new t(new ArrayBuffer(0))))};var ut=function(){function t(){return this.i++,this.buffer.readUInt8(this.i-1)}function e(){return this.i++,this.buffer.readInt8(this.i-1)}function r(){return this.i+=2,this.buffer.readUInt16LE(this.i-2)}function i(){return this.i+=2,this.buffer.readInt16LE(this.i-2)}function n(){return this.i+=4,this.buffer.readUInt32LE(this.i-4)}function s(){return this.i+=4,this.buffer.readInt32LE(this.i-4)}function a(){return this.i+=4,this.buffer.readFloatLE(this.i-4)}function h(){return this.i+=8,this.buffer.readDoubleLE(this.i-8)}function p(t){return t===f?this.readUInt8():t===(f|u)?this.readInt8():t===o?this.readUInt16():t===(o|u)?this.readInt16():t===c?this.readUInt32():t===(c|u)?this.readInt32():t===l?this.readFloat():t===d?this.readDouble():void 0}return function(){this.readUInt8=t,this.readInt8=e,this.readUInt16=r,this.readInt16=i,this.readUInt32=n,this.readInt32=s,this.readFloat=a,this.readDouble=h,this.readValue=p}}(),ft=function(){function t(t){var e="",r=this.buffer.readUInt8(),i=this.buffer.readValue(r),n=0;if(t){for(;i>n;)e+=String.fromCharCode(this.buffer.readUInt16()),++n;return e}for(;i>n;)e+=String.fromCharCode(this.buffer.readUInt8()),++n;return e}function e(){if(this.state&h)throw Error("Already parsed string index.");var t;switch(this.stringIndexType=this.buffer.readUInt8(),this.stringIndexType){case f:case o:case c:t=this.buffer.readValue(this.stringIndexType);break;case m:t=0;break;default:throw Error("Invalid LEON.")}for(var e=0;t>e;++e)this.stringIndex.push(this.readString());return this.state|=h,this}function r(){if(this.state&h||this.parseSI(),!this.stringIndex.length)return this;var t,e,r,i;switch(this.OLItype=this.buffer.readUInt8(),this.OLItype){case f:case o:case c:t=this.buffer.readValue(this.OLItype);break;case m:return this;default:throw Error("Invalid LEON.")}for(r=0;t>r;++r)for(this.objectLayoutIndex.push([]),e=this.buffer.readValue(this.buffer.readUInt8()),i=0;e>i;++i)this.objectLayoutIndex[r].push(this.buffer.readValue(this.stringIndexType));return this}function i(t){var e,r,i,n;if("undefined"==typeof t&&(t=this.spec),t===y)return e=this.readString();if(t===w)return e=this.readString(!0);if(t===j)return this.parseValue();if("object"!=typeof t)return t===(E&U)?this.parseValue():this.parseValue(t);if(Array.isArray(t)){if(0===t.length)return this.parseValue(g);if(t.object){for(e={},r=0;r<t.length;r+=2)e[t[r]]=this.parseValueWithSpec(t[r+1]);return e}for(t=t[0],n=this.buffer.readUInt8(),i=this.buffer.readValue(n),e=new Array(i),r=0;i>r;++r)e[r]=this.parseValueWithSpec(t);return e}}function n(t){"undefined"==typeof t&&(t=this.buffer.readUInt8());var e,r,i,n,s;if(I>t)return this.buffer.readValue(t);switch(t){case g:for(t=this.buffer.readUInt8(),e=this.buffer.readValue(t),i=new Array(e),r=0;e>r;++r)i[r]=this.parseValue();return i;case I:if(i={},this.state&h)for(n=this.objectLayoutIndex[this.buffer.readValue(this.OLItype)],r=0;r<n.length;++r)i[this.stringIndex[n[r]]]=this.parseValue();else for(e=this.buffer.readValue(this.buffer.readUInt8()),r=0;e>r;++r)s=this.readString(),i[s]=this.parseValue();break;case y:return this.state&h?this.stringIndex[this.buffer.readValue(this.stringIndexType)]:this.readString();case w:return this.readString(!0);case L:return void 0;case E:return!0;case U:return!1;case v:return null;case N:return 0/0;case x:return Number.NEGATIVE_INFINITY;case S:return Number.POSITIVE_INFINITY;case A:return new Date(this.buffer.readValue(d));case O:if(e=this.buffer.readValue(this.buffer.readUInt8()),F)for(i=new Buffer(e),r=0;e>r;++r)i[r]=this.buffer.readUInt8();else{i=new ArrayBuffer(e);var a=new Uint8Array(i);for(r=0;e>r;++r)a[r]=this.buffer.readUInt8()}return i;case V:return RegExp(this.readString(),this.readString());default:throw Error("Invalid LEON.")}return i}return function(){this.parseValue=n,this.parseValueWithSpec=i,this.readString=t,this.parseOLI=r,this.parseSI=e}}(),ot=function(){function t(){return"undefined"!=typeof this.spec?this.writeValueWithSpec(this.payload):this.writeValue(this.payload,k(this.payload)),this}function e(){if(F){for(var t=new Buffer(this.i),e=0;e<this.i;++e)t[e]=this.buffer.uchars[e];return t}return this.buffer.buffer.slice(0,this.i)}function r(t,e){var r,i=typeof t;if("undefined"==typeof e&&(e=this.spec),"object"==typeof e)if(Array.isArray(e))if(e.object){if("object"!=typeof t)throw TypeError("Was expecting an object but instead got a "+i+".");for(r=0;r<e.length;r+=2)this.writeValueWithSpec(t[e[r]],e[r+1])}else{if(!Array.isArray(t))throw TypeError("Was expecting an array but instead got a "+i+".");for(this.writeValue(t.length,k(t.length)),r=0;r<t.length;++r)this.writeValueWithSpec(t[r],e[0])}else"[object Date]"===toString.call(t)&&this.writeValue(t,A,!0);else e===j?this.writeValue(t,k(t)):e===(E&U)?this.writeValue(t,k(t),!0):this.writeValue(t,e,!0)}function i(t){return this.buffer.writeUInt8(t,this.i),this.i++,this}function n(t,e,r){var i,n,s,a,j;switch(e){case L:case E:case U:case v:case N:case x:case S:return this.appendUInt8(e),1;case w:return r||this.appendUInt8(e),void this.writeString(t,!0);case y:return r||this.appendUInt8(e),this.state&h&&this.stringIndex?(this.writeValue(this.stringIndex.indexOf(t),this.stringIndexType,!0),2):(this.writeString(t),2+t.length);case u:return r||this.appendUInt8(e),this.buffer.writeInt8(t,this.i),this.i++,2;case f:return r||this.appendUInt8(e),this.buffer.writeUInt8(t,this.i),this.i++,2;case p:return r||this.appendUInt8(e),this.buffer.writeInt16LE(t,this.i),this.i+=2,3;case o:return r||this.appendUInt8(e),this.buffer.writeUInt16LE(t,this.i),this.i+=2,3;case b:return r||this.appendUInt8(e),this.buffer.writeInt32LE(t,this.i),this.i+=4,5;case c:return r||this.appendUInt8(e),this.buffer.writeUInt32LE(t,this.i),this.i+=4,5;case l:return r||this.appendUInt8(e),this.buffer.writeFloatLE(t,this.i),this.i+=4,5;case d:return r||this.appendUInt8(e),this.buffer.writeDoubleLE(t,this.i),this.i+=8,9;case g:for(r||this.appendUInt8(e),this.writeValue(t.length,k(t.length)),n=0;n<t.length;++n)this.writeValue(t[n],k(t[n]));break;case I:if(r||this.appendUInt8(e),this.state&h)for(a=Y(t,this.stringIndex,this.OLI),r||this.writeValue(a,this.OLItype,!0),n=0;n<this.OLI[a].length;++n)s=t[this.stringIndex[this.OLI[a][n]]],this.writeValue(s,k(s));else for(a=Object.getOwnPropertyNames(t),this.writeValue(a.length,k(a.length)),n=0;n<a.length;++n)this.writeString(a[n]),this.writeValue(t[a[n]],k(t[a[n]]));break;case A:r||this.appendUInt8(e),this.writeValue(t.valueOf(),d,!0);break;case O:if(r||this.appendUInt8(e),t instanceof ArrayBuffer)for(i=new Uint8Array(t),this.writeValue(i.length,k(i.length)),n=0;n<i.length;++n)this.writeValue(i[n],f,!0);else if(F&&Buffer.isBuffer(t))for(this.writeValue(t.length,k(t.length)),n=0;n<t.length;++n)this.writeValue(t[n],f,!0);break;case V:return r||this.appendUInt8(e),j=H(t),this.writeString(j[0]),this.writeString(j[1]),j.reduce(function(t,e){return t+e.length+1},0)}}function s(t,e){if(this.writeValue(t.length,k(t.length)),e)for(var r=0;r<t.length;++r)this.writeValue(t.charCodeAt(r),o,!0);else for(var r=0;r<t.length;++r)this.appendUInt8(t.charCodeAt(r))}function a(t){return this.stringIndex.length?(this.OLI=X(this.payload,this.stringIndex),this.OLI.length?(this.OLItype=k(this.OLI.length),this.writeValue(this.OLI.length,this.OLItype),this.OLI.forEach(function(t){var e=k(t.length);this.writeValue(t.length,e),t.forEach(function(t){this.writeValue(t,this.stringIndexType,!0)},this)},this),this):(this.writeValue(m,f,!0),this)):this}function T(){return this.stringIndex=z(this.payload),this.stringIndex.length?(this.stringIndexType=k(this.stringIndex.length),this.writeValue(this.stringIndex.length,this.stringIndexType),this.stringIndex.forEach(function(t){this.writeString(t)},this),this.state|=h,this):(this.state|=h,this.writeValue(m,f,!0),this)}return function(){this.writeData=t,this["export"]=e,this.writeValueWithSpec=r,this.writeValue=n,this.appendUInt8=i,this.writeString=s,this.writeSI=T,this.writeOLI=a}}();it.prototype={inspect:function(t,r,i,n,s,a){var h="",u=!1;"undefined"==typeof r&&(r={colors:!1}),"undefined"==typeof a&&(a={}),"undefined"==typeof s&&(h+="{[Channel] ",s=!1,u=!0);var f,o;if("undefined"==typeof i&&(n=0),"undefined"==typeof i&&(i=this.spec),"object"==typeof i)if(Array.isArray(i))h+="["+this.inspect(t,r,i[0],n,s,a)+"]";else{for(a.flag=!0,h+="{\n",f=Object.getOwnPropertyNames(i),o=0;o<f.length;++o)h+=nt("  ",n+1)+st(f[o],r.colors)+": "+this.inspect(t,r,i[f[o]],n+1,s,a)+(f.length-1===o?"":",")+"\n";h+=nt("  ",n)+"}"}else h+=e(i);return u&&(h+="}"),h},bufferify:function(t){return W(t,this.sorted).writeData()["export"]()},parse:function(e){return R(t(e),this.sorted).parseValueWithSpec()}};var ct={};return r(ct)(B)(D),ct.parse=Q,ct.bufferify=Z,ct.toTemplate=q,ct.Channel=it,ct.noConflict=function(){return s},ct}();"undefined"!=typeof exports?"undefined"!=typeof module&&module.exports&&(exports=module.exports=W):n.LEON=W}).call(this);