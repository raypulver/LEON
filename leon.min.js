"use strict";(function(){function t(e,r){if("undefined"==typeof r){if("object"!=typeof e)throw TypeError("Argument must be an object");return t.bind(this,e)}if("object"!=typeof r)throw TypeError("Argument must be an object");return Object.getOwnPropertyNames(r).forEach(function(t){this[t]=r[t]},e),t.bind(this,e)}var e=this,r=(e.LEON,1),n=1,s=0,a=2,h=4,u=6,f=7,o=3,c=5,d=128,p=9,l=16,b=32,I=33,g=64,w=20,y=21,E=22,S=23,L=24,O=25,V=26,v=221,N=255,x=1,C={USE_INDEXING:x},U={CHAR:n|s,UNSIGNED_CHAR:s,SHORT:n|a,UNSIGNED_SHORT:a,INT:n|h,UNSIGNED_INT:h,FLOAT:u,DOUBLE:f,ARRAY:d,OBJECT:p,STRING:l,BOOLEAN:b&I,NULL:g,UNDEFINED:w,DATE:y,NAN:L,BUFFER:E,REGEXP:S,MINUS_INFINITY:V,INFINITY:O,DYNAMIC:v},m=function(){function e(t){return this instanceof e?void(this.buffer=t?t:""):new e(t)}function m(t,e,r){for(var i="",n=0;n<r-t.length;++n)i+=e;return i+=t}function M(t,e){var r,i,n,s;if(!e)return~t;if(e>31){for(r=t.toString(2),r=m(r,"0",e),i="",n=0;n<r.length;++n)i+="0"===r[n]?"1":"0";return s=parseInt(i,2),s+=1}return(t^j(e))+1}function j(t){return(1<<t)-1}function A(t){return this instanceof A?(this.buffer=t,void(this.i=0)):new A(t)}function T(t,e){return this instanceof T?(this.buffer=A(t),this.state=0,this.stringIndex=[],this.objectLayoutIndex=[],void(this.spec=e)):new T(t,e)}function D(t,e){var r;if("object"==typeof t){if(null===t)return g;if(Array.isArray(t))return d;if(r=toString.call(t),"[object Date]"===r)return y;if("[object RegExp]"===r)return S;try{if(Buffer.isBuffer(t))return E}catch(i){try{if(t instanceof StringBuffer)return E}catch(i){}}return p}if("function"==typeof t||"undefined"==typeof t)return w;if("boolean"==typeof t)return t?b:I;if("string"==typeof t)return l;if("number"==typeof t){if(t!==t)return L;if(t===Number.NEGATIVE_INFINITY)return V;if(t===Number.POSITIVE_INFINITY)return O;var o,c=0,v=t;return v%1||e?(v=Math.abs(t),o=Math.log(v)/Math.LN2,o=0>o?Math.ceil(o):Math.floor(o),c=103+o,0>c||c>255?f:(v*=Math.pow(2,-o+24),Math.floor(v)!=v?f:u)):0>v?Math.abs(v)<=128?n|s:Math.abs(v)<=32768?n|a:Math.abs(v)<=Math.pow(2,31)?n|h:f:256>v?s:65536>v?a:v<Math.pow(2,32)?h:f}}function F(t,r){return this instanceof F?(this.payload=t,this.buffer=e(),this.spec=r,void(this.state=0)):new F(t,r)}function B(t,e,r){for(var i,n,s,a=0,h=Object.getOwnPropertyNames(t).map(function(t){return e.indexOf(t)}).sort(function(t,e){return t-e});a<r.length;)if(s=!1,h.length===r[a].length){for(n=r[a].slice().sort(function(t,e){return t-e}),i=0;i<h.length;++i)if(h[i]!==n[i]){s=!0;break}if(!s)return a;++a}else++a}function R(t){return t=t.toString(),[t.substr(1,t.lastIndexOf("/")-1),t.substr(t.lastIndexOf("/")+1)]}function P(t,e,r,i){var n,s,a,h;if(r||(r=[]),void 0===i&&(i=t),"object"==typeof i&&!Buffer.isBuffer(i)&&"[object RegExp]"!==toString.call(i)&&"[object Date]"!==toString.call(i)&&null!==i)for(n=Object.getOwnPropertyNames(i),Array.isArray(i)||"[object Date]"===toString.call(i)||(h=[],n.forEach(function(t){h.push(e.indexOf(t))}),h.sort(function(t,e){return t-e}),function(t,e){var r;for(s=0;s<t.length;++s)if(r=!1,t[s].length===e.length){for(a=0;a<e.length;++a)if(e[a]!==t[s][a]){r=!0;break}if(!r)return!1}return!0}(r,h)&&r.push(h)),s=0;s<n.length;++s)P(t,e,r,i[n[s]]);return r}function k(t,e,r){e||(e=[]),void 0===r&&(r=t);var i,n;if("object"!=typeof r||"[object RegExp]"===toString.call(r)||"[object Date]"===toString.call(r)||Buffer.isBuffer(r))"string"==typeof r&&Y(e,r);else for(i=Object.getOwnPropertyNames(r),Array.isArray(r)||i.forEach(function(t){Y(e,t)}),n=0;n<i.length;++n)k(t,e,r[i[n]]);return e}function _(t){var e=D(t[0]);switch(e){case s:case n:case a:case o:case h:case c:case u:case f:for(var r=Math.abs(t[0]),i=t[0]%1!==0,l=t[0]<0?1:0,g=1;g<t.length;++g){if("number"!=typeof t[g])return v;Math.abs(t[g])>r&&(r=Math.abs(t[g])),t[g]%1!==0&&(i=!0),t[g]<0&&(l=1)}return D((l?-1:1)*r,i);case d:return[_(t.reduce(function(t,e){return t.concat(e)},[]))];case p:var w={};return Object.getOwnPropertyNames(t[0]).forEach(function(e){w[e]=_(G(t,e))}),w;default:e===I&&(e=b);for(var y,g=1;g<t.length;++g)if(y=D(t[g]),y===I&&(y=b),y!==e)return v;return e}}function G(t,e){for(var r=[],i=0;i<t.length;++i){if("object"!=typeof t[i])throw Error("Received a non-object value when an object was expected.");if("undefined"==typeof t[i][e])throw Error("Object "+JSON.stringify(t[i])+" has no property "+String(e)+".");r.push(t[i][e])}return r}function W(t){var e=D(t);switch(e){case d:return[_(t)];case p:var r={};return Object.getOwnPropertyNames(t).forEach(function(e){r[e]=W(t[e])}),r;case I:return b;default:return e}}function Y(t,e){-1===t.indexOf(e)&&t.push(e)}function H(t,r){var i=T(e(t));return r&x&&i.parseSI().parseOLI(),i.parseValue()}function J(t,e){var r=F(t);return e&x&&r.writeSI().writeOLI(),r.writeData()["export"]()}function X(t){return this instanceof X?void(this.spec=t):new X(t)}e.concat=function(t){return e(t.reduce(function(t,e){return t+e.buffer},""))},e.fromString=function(t){for(var r=e(),i=0;t[i];)r.writeUInt8(t.charCodeAt(i),i),i++;return r},e.prototype={writeUInt8:function(t,e){return t=+t,e===this.buffer.length||-1===e?this.buffer+=String.fromCharCode(t):this.buffer=this.buffer.substr(0,e)+String.fromCharCode(t)+this.buffer.substr(e+1),e+1},writeInt8:function(t,e){return t=+t,t=0>t?M(-t,8):t,e===this.buffer.length||-1===e?this.buffer+=String.fromCharCode(t):this.buffer=this.buffer.substr(0,e)+String.fromCharCode(t)+this.buffer.substr(e+1),e+1},writeUInt16LE:function(t,e){return t=+t,e===this.buffer.length||-1===e?(this.buffer+=String.fromCharCode(255&t),this.buffer+=String.fromCharCode(t>>>8)):this.buffer=this.buffer.substr(0,e)+String.fromCharCode(255&t)+String.fromCharCode(t>>>8)+this.buffer.substr(e+2),e+2},writeInt16LE:function(t,e){return t=+t,t=0>t?M(-t,16):t,this.writeUInt16LE(t,e)},writeUInt32LE:function(t,e){t=+t,e===this.buffer.length||-1===e?this.buffer+=String.fromCharCode(255&t)+String.fromCharCode(t>>>8&255)+String.fromCharCode(t>>>16&255)+String.fromCharCode(t>>>24&255):this.buffer=this.buffer.substr(0,e)+String.fromCharCode(255&t)+String.fromCharCode(t>>>8&255)+String.fromCharCode(t>>>16&255)+String.fromCharCode(t>>>24&255)+this.buffer.substr(e+4)},writeInt32LE:function(t,e){return t=+t,t=0>t?M(-t,32):t,this.writeUInt32LE(t,e)},writeFloatLE:function(t,e){var r,i,n=127,s=[];r=0>t?1:0,t=Math.abs(t),i=Math.log(t)/Math.LN2,i=0>i?Math.ceil(i):Math.floor(i),t*=Math.pow(2,-i+23),n+=i,t=Math.round(t),t&=8388607,s.push(r<<7),s[0]|=(254&n)>>1,s.push((1&n)<<7),s[1]|=t>>16&127,s.push(t>>8&255),s.push(255&t);for(var a=3;a>=0;--a)this.writeUInt8(s[a],e+(3-a));return e+4},writeDoubleLE:function(t,e){var r,i,n=1023;r=0>t?1:0,t=Math.abs(t),i=Math.log(t)/Math.LN2,i=0>i?Math.ceil(i):Math.floor(i),t*=Math.pow(2,-i+52),n+=i,t=Math.round(t),t=parseInt(t.toString(2).substr(1),2);var s=[];s.push(r<<7),s[0]|=n>>4,s.push((15&n)<<4),s[1]|=15&Math.floor(t*Math.pow(2,-48));for(var a=40,h=0;6>h;++h)s.push(255&Math.floor(t*Math.pow(2,-a))),a-=8;for(h=7;h>=0;--h)this.writeUInt8(s[h],e+(7-h));return e+8},readUInt8:function(t){return t>>>=0,this.buffer.charCodeAt(t)},readInt8:function(t){t>>>=0;var e=this.buffer.charCodeAt(t);return 128&e?-M(e,8):e},readUInt16LE:function(t){return t>>>=0,this.buffer.charCodeAt(t)|this.buffer.charCodeAt(t+1)<<8},readInt16LE:function(t){var e=this.readUInt16LE(t);return 32768&e?-M(e,16):e},readUInt32LE:function(t){return t>>>=0,this.buffer.charCodeAt(t)|this.buffer.charCodeAt(t+1)<<8|this.buffer.charCodeAt(t+2)<<16|this.buffer.charCodeAt(t+3)<<24},readInt32LE:function(t){var e=this.readUInt32LE(t);return 0>e?e:2147483648&e?-M(e,32):e},readFloatLE:function(t){for(var e=[],r=3;r>=0;--r)e.push(this.readUInt8(t+r));var i=(128&e[0])>>7,n=(127&e[0])<<1|(128&e[1])>>7,s=0;e[1]&=127;for(var r=0;2>=r;++r)s|=e[r+1]*Math.pow(2,8*(2-r));return s|=8388608,(1===i?-s:s)*Math.pow(2,n-150)},readDoubleLE:function(t){for(var e=[],r=7;r>=0;--r)e.push(this.readUInt8(t+r));var i=(128&e[0])>>7,n=(127&e[0])<<4|(240&e[1])>>4,s=0;e[1]&=15;for(var r=0;6>=r;++r)s+=e[r+1]*Math.pow(2,8*(6-r));return s+=4503599627370496,(1===i?-s:s)*Math.pow(2,n-1075)}},A.prototype={exhausted:function(){return i>=this.buffer.length},readUInt8:function(){return this.i++,this.buffer.readUInt8(this.i-1)},readInt8:function(){return this.i++,this.buffer.readInt8(this.i-1)},readUInt16:function(){return this.i+=2,this.buffer.readUInt16LE(this.i-2)},readInt16:function(){return this.i+=2,this.buffer.readInt16LE(this.i-2)},readUInt32:function(){return this.i+=4,this.buffer.readUInt32LE(this.i-4)},readInt32:function(){return this.i+=4,this.buffer.readInt32LE(this.i-4)},readInt64:function(){return this.i+=8,this.buffer.readInt64LE(this.i-8)},readFloat:function(){return this.i+=4,this.buffer.readFloatLE(this.i-4)},readDouble:function(){return this.i+=8,this.buffer.readDoubleLE(this.i-8)},readValue:function(t){return t===s?this.readUInt8():t===(s|n)?this.readInt8():t===a?this.readUInt16():t===(a|n)?this.readInt16():t===h?this.readUInt32():t===(h|n)?this.readInt32():t===u?this.readFloat():t===f?this.readDouble():void 0}},T.prototype={readString:function(){for(var t="",e=this.buffer.readUInt8(),r=this.buffer.readValue(e),i=0;r>i;)t+=String.fromCharCode(this.buffer.readUInt8()),++i;return t},parseSI:function(){if(this.state&r)throw Error("Already parsed string index.");var t;switch(this.stringIndexType=this.buffer.readUInt8(),this.stringIndexType){case s:case a:case h:t=this.buffer.readValue(this.stringIndexType);break;case N:t=0;break;default:throw Error("Invalid LEON.")}for(var e=0;t>e;++e)this.stringIndex.push(this.readString());return this.state|=r,this},parseOLI:function(){if(this.state&r||this.parseSI(),!this.stringIndex.length)return this;var t,e,i,n;switch(this.OLItype=this.buffer.readUInt8(),this.OLItype){case s:case a:case h:t=this.buffer.readValue(this.OLItype);break;case N:return this;default:throw Error("Invalid LEON.")}for(i=0;t>i;++i)for(this.objectLayoutIndex.push([]),e=this.buffer.readValue(this.buffer.readUInt8()),n=0;e>n;++n)this.objectLayoutIndex[i].push(this.buffer.readValue(this.stringIndexType));return this},parseValueWithSpec:function(t){var e,r,i,n,s;if("undefined"==typeof t&&(t=this.spec),t===l)return e=this.readString();if(t===v)return this.parseValue();if("object"==typeof t){if(Array.isArray(t)){if(0===t.length)return this.parseValue(d);for(t=t[0],s=this.buffer.readUInt8(),i=this.buffer.readValue(s),e=[],r=0;i>r;++r)e.push(this.parseValueWithSpec(t));return e}for(e={},n=Object.getOwnPropertyNames(t),n.sort(function(t,e){return t>e}),r=0;r<n.length;++r)e[n[r]]=this.parseValueWithSpec(t[n[r]]);return e}return t===(b&I)?this.parseValue():this.parseValue(t)},parseValue:function(t){"undefined"==typeof t&&(t=this.buffer.readUInt8());var e,i,n,a,h;if(p>t)return this.buffer.readValue(t);switch(t){case d:for(t=this.buffer.readUInt8(),e=this.buffer.readValue(t),n=[],i=0;e>i;++i)n.push(this.parseValue());return n;case p:if(n={},this.state&r)for(a=this.objectLayoutIndex[this.buffer.readValue(this.OLItype)],i=0;i<a.length;++i)n[this.stringIndex[a[i]]]=this.parseValue();else for(e=this.buffer.readValue(this.buffer.readUInt8()),i=0;e>i;++i)h=this.readString(),n[h]=this.parseValue();break;case l:return this.state&r?this.stringIndex[this.buffer.readValue(this.stringIndexType)]:this.readString();case w:return void 0;case b:return!0;case I:return!1;case g:return null;case L:return 0/0;case V:return Number.NEGATIVE_INFINITY;case O:return Number.POSITIVE_INFINITY;case y:return new Date(this.buffer.readValue(f));case E:e=this.buffer.readValue(this.buffer.readUInt8());try{n=new Buffer(e)}catch(u){try{n=StringBuffer()}catch(u){throw Error("LEON object contains a Buffer but StringBuffer has not been loaded.")}}for(i=0;e>i;++i)n.writeUInt8(this.buffer.readValue(s),i);return n;case S:return RegExp(this.readString(),this.readString());default:throw Error("Invalid LEON.")}return n}},F.prototype={append:function(t){this.buffer=e.concat([this.buffer,t])},writeData:function(){return"undefined"!=typeof this.spec?this.writeValueWithSpec(this.payload):this.writeValue(this.payload,D(this.payload)),this},"export":function(){return this.buffer.buffer},writeValueWithSpec:function(t,e){var r,i;if("undefined"==typeof e&&(e=this.spec),"object"==typeof e)if(Array.isArray(e))for(this.writeValue(t.length,D(t.length)),i=0;i<t.length;++i)this.writeValueWithSpec(t[i],e[0]);else if("[object Date]"===toString.call(t))this.writeValue(t,y,!0);else for(r=Object.getOwnPropertyNames(e),r.sort(function(t,e){return t>e}),i=0;i<r.length;++i)this.writeValueWithSpec(t[r[i]],e[r[i]]);else e===v?this.writeValue(t,D(t)):e===(b&I)?this.writeValue(t,D(t),!0):this.writeValue(t,e,!0)},writeValue:function(t,i,v){var N,x,C,U,m,M=e();switch(M.writeUInt8(i,0),i){case w:case b:case I:case g:case L:case V:case O:return this.append(M),1;case l:return v||this.append(M),this.state&r&&this.stringIndex?(this.writeValue(this.stringIndex.indexOf(t),this.stringIndexType,!0),2):(this.writeString(t),2+t.length);case n:return v||this.append(M),N=e(),N.writeInt8(t,0),this.append(N),2;case s:return v||this.append(M),N=e(),N.writeUInt8(t,0),this.append(N),2;case o:return v||this.append(M),N=e(),N.writeInt16LE(t,0),this.append(N),3;case a:return v||this.append(M),N=e(),N.writeUInt16LE(t,0),this.append(N),3;case c:return v||this.append(M),N=e(),N.writeInt32LE(t,0),this.append(N),5;case h:return v||this.append(M),N=e(),N.writeUInt32LE(t,0),this.append(N),5;case u:return v||this.append(M),N=e(),N.writeFloatLE(t,0),this.append(N),5;case f:return v||this.append(M),N=e(),N.writeDoubleLE(t,0),this.append(N),9;case d:for(v||this.append(M),this.writeValue(t.length,D(t.length)),x=0;x<t.length;++x)this.writeValue(t[x],D(t[x]));break;case p:if(v||this.append(M),this.state&r)for(U=B(t,this.stringIndex,this.OLI),v||this.writeValue(U,this.OLItype,!0),x=0;x<this.OLI[U].length;++x)C=t[this.stringIndex[this.OLI[U][x]]],this.writeValue(C,D(C));else for(U=Object.getOwnPropertyNames(t),this.writeValue(U.length,D(U.length)),x=0;x<U.length;++x)this.writeString(U[x]),this.writeValue(t[U[x]],D(t[U[x]]));break;case y:v||this.append(M),this.writeValue(t.valueOf(),f,!0);break;case E:for(v||this.append(M),this.writeValue(t.length,D(t.length)),x=0;x<t.length;++x)this.writeValue(t[x],s,!0);break;case S:return v||this.append(M),m=R(t),this.writeString(m[0]),this.writeString(m[1]),m.reduce(function(t,e){return t+e.length+1},0)}},writeString:function(t){this.writeValue(t.length,D(t.length));for(var e=0;e<t.length;++e)this.writeValue(t.charCodeAt(e),s,!0)},writeOLI:function(t){return this.stringIndex.length?(this.OLI=P(this.payload,this.stringIndex),this.OLI.length?(this.OLItype=D(this.OLI.length),this.writeValue(this.OLI.length,this.OLItype),this.OLI.forEach(function(t){var e=D(t.length);this.writeValue(t.length,e),t.forEach(function(t){this.writeValue(t,this.stringIndexType,!0)},this)},this),this):(this.writeValue(N,s,!0),this)):this},writeSI:function(){return this.stringIndex=k(this.payload),this.stringIndex.length?(this.stringIndexType=D(this.stringIndex.length),this.writeValue(this.stringIndex.length,this.stringIndexType),this.stringIndex.forEach(function(t){this.writeString(t)},this),this.state|=r,this):(this.state|=r,this.writeValue(N,s,!0),this)}},X.prototype={stringify:function(t){return F(t,this.spec).writeData()["export"]()},parse:function(t){return T(e(t),this.spec).parseValueWithSpec()}};var q={};return t(q)(U)(C),q.parse=H,q.stringify=J,q.toTemplate=W,q.Channel=X,q}();"undefined"!=typeof exports?"undefined"!=typeof module&&module.exports&&(exports=module.exports=m):e.LEON=m}).call(this);