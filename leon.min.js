"use strict";(function(){var t=this,e=(t.LEON,1),r=1,n=0,s=2,a=4,f=6,u=7,h=3,o=5,c=128,d=9,l=16,p=32,I=33,b=64,g=20,w=21,y=22,E=23,S=24,L=25,v=26,O=255,V=function(){var t=new Float32Array(1);return t[0]=.125,0===t.buffer[0]}(),U={CHAR:r|n,UNSIGNED_CHAR:n,SHORT:r|s,UNSIGNED_SHORT:s,INT:r|a,UNSIGNED_INT:a,FLOAT:f,DOUBLE:u,ARRAY:c,OBJECT:d,STRING:l,BOOLEAN:p&I,NULL:b,UNDEFINED:g,DATE:w,BUFFER:y,REGEXP:E,MINUS_INFINITY:v,POSITIVE_INFINITY:L},x=function(){function t(e){return this instanceof t?void(this.buffer=e?e:""):new t(e)}function x(t,e){return e>31||!e?~t:(t^C(e))+1}function C(t){return(1<<t)-1}function N(t){return this instanceof N?(this.buffer=t,void(this.i=0)):new N(t)}function m(t,e){return this instanceof m?(this.buffer=N(t),this.state=0,this.stringIndex=[],this.objectLayoutIndex=[],void(this.spec=e)):new m(t,e)}function A(t,e){var i;if("object"==typeof t){if(null===t)return b;if(Array.isArray(t))return c;if(i=toString.call(t),"[object Date]"===i)return w;if("[object RegExp]"===i)return E;try{if(Buffer.isBuffer(t))return y}catch(h){try{if(t instanceof StringBuffer)return y}catch(h){}}return d}if("function"==typeof t||"undefined"==typeof t)return g;if("boolean"==typeof t)return t?p:I;if("string"==typeof t)return l;if("number"==typeof t){if(t!==t)return S;if(t===Number.NEGATIVE_INFINITY)return v;if(t===Number.POSITIVE_INFINITY)return L;var o=t;if(o%1||e){var O=new Float32Array(1);return O[0]=o,o!==O[0]?u:f}return 0>o?Math.abs(o)<=128?r|n:Math.abs(o)<=32768?r|s:Math.abs(o)<=Math.pow(2,31)?r|a:u:256>o?n:65536>o?s:o<Math.pow(2,32)?a:u}}function T(e,r){return this instanceof T?(this.payload=e,this.buffer=t(),void(this.spec=r)):new T(e,r)}function j(t,e,r){for(var n,i,s,a=0,f=Object.getOwnPropertyNames(t).map(function(t){return e.indexOf(t)}).sort(function(t,e){return t-e});a<r.length;)if(s=!1,f.length===r[a].length){for(i=r[a].slice().sort(function(t,e){return t-e}),n=0;n<f.length;++n)if(f[n]!==i[n]){s=!0;break}if(!s)return a;++a}else++a}function D(t){return t=t.toString(),[t.substr(1,t.lastIndexOf("/")-1),t.substr(t.lastIndexOf("/")+1)]}function F(t,e,r,n){var i,s;if(r||(r=[]),void 0===n&&(n=t),"object"==typeof n&&!Buffer.isBuffer(n)&&"[object RegExp]"!==toString.call(n)&&"[object Date]"!==toString.call(n)&&null!==n)for(i=Object.getOwnPropertyNames(n),Array.isArray(n)||"[object Date]"===toString.call(n)||(r.push([]),i.forEach(function(t){r[r.length-1].push(e.indexOf(t))})),s=0;s<i.length;++s)F(t,e,r,n[i[s]]);return r}function B(t,e,r){e||(e=[]),void 0===r&&(r=t);var n,i;if("object"!=typeof r||"[object RegExp]"===toString.call(r)||"[object Date]"===toString.call(r)||Buffer.isBuffer(r))"string"==typeof r&&M(e,r);else for(n=Object.getOwnPropertyNames(r),Array.isArray(r)||n.forEach(function(t){M(e,t)}),i=0;i<n.length;++i)B(t,e,r[n[i]]);return e}function R(t){var e=A(t[0]);switch(e){case n:case r:case s:case h:case a:case o:case f:case u:for(var i=Math.abs(t[0]),l=t[0]%1!==0,b=t[0]<0?1:0,g=1;g<t.length;++g){if("number"!=typeof t[g])throw Error("Received a non-numerical value in an array of numbers.");Math.abs(t[g])>i&&(i=Math.abs(t[g])),t[g]%1!==0&&(l=!0),t[g]<0&&(b=1)}return A((b?-1:1)*i,l);case c:return[R(t.reduce(function(t,e){return t.concat(e)},[]))];case d:var w={};return Object.getOwnPropertyNames(t[0]).forEach(function(e){w[e]=R(P(t,e))}),w;default:e===I&&(e=p);for(var y,g=1;g<t.length;++g)if(y=A(t[g]),y===I&&(y=p),y!==e)throw new Error("Type mismatch.");return e}}function P(t,e){for(var r=[],n=0;n<t.length;++n){if("object"!=typeof t[n])throw Error("Received a non-object value when an object was expected.");if("undefined"==typeof t[n][e])throw Error("Object "+JSON.stringify(t[n])+" has no property "+String(e)+".");r.push(t[n][e])}return r}function k(t){var e=A(t);switch(e){case c:return[R(t)];case d:var r={};return Object.getOwnPropertyNames(t).forEach(function(e){r[e]=k(t[e])}),r;case I:return p;default:return e}}function M(t,e){-1===t.indexOf(e)&&t.push(e)}function _(e){return m(t(e)).parseSI().parseOLI().parseValue()}function W(t){return T(t).writeSI().writeOLI().writeData()["export"]()}function G(t){return this instanceof G?void(this.spec=t):new G(t)}t.concat=function(e){return t(e.reduce(function(t,e){return t+e.buffer},""))},t.fromString=function(e){for(var r=t(),n=0;e[n];)r.writeUInt8(e.charCodeAt(n),n),n++;return r},t.prototype={writeUInt8:function(t,e){return t=+t,e===this.buffer.length||-1===e?this.buffer+=String.fromCharCode(t):this.buffer=this.buffer.substr(0,e)+String.fromCharCode(t)+this.buffer.substr(e+1),e+1},writeInt8:function(t,e){return t=+t,t=0>t?x(-t,8):t,e===this.buffer.length||-1===e?this.buffer+=String.fromCharCode(t):this.buffer=this.buffer.substr(0,e)+String.fromCharCode(t)+this.buffer.substr(e+1),e+1},writeUInt16LE:function(t,e){return t=+t,e===this.buffer.length||-1===e?(this.buffer+=String.fromCharCode(255&t),this.buffer+=String.fromCharCode(t>>>8)):this.buffer=this.buffer.substr(0,e)+String.fromCharCode(255&t)+String.fromCharCode(t>>>8)+this.buffer.substr(e+2),e+2},writeInt16LE:function(t,e){return t=+t,t=0>t?x(-t,16):t,this.writeUInt16LE(t,e)},writeUInt32LE:function(t,e){t=+t,e===this.buffer.length||-1===e?this.buffer+=String.fromCharCode(255&t)+String.fromCharCode(t>>>8&255)+String.fromCharCode(t>>>16&255)+String.fromCharCode(t>>>24&255):this.buffer=this.buffer.substr(0,e)+String.fromCharCode(255&t)+String.fromCharCode(t>>>8&255)+String.fromCharCode(t>>>16&255)+String.fromCharCode(t>>>24&255)+this.buffer.substr(e+4)},writeInt32LE:function(t,e){return t=+t,t=0>t?x(-t,32):t,this.writeUInt32LE(t,e)},writeFloatLE:function(t,e){var r=new Float32Array(1);if(r[0]=t,V)for(var n=0;4>n;++n)this.writeUInt8(r.buffer[n],e+n);else for(var n=3;n>=0;--n)this.writeUInt8(r.buffer[n],e+(3-n));return e+4},writeDoubleLE:function(t,e){var r=new Float64Array(1);if(r[0]=t,V)for(var n=0;8>n;++n)this.writeUInt8(r.buffer[n],e+n);else for(var n=7;n>=0;--n)this.writeUInt8(r.buffer[n],e+(7-n));return e+8},readUInt8:function(t){return t>>>=0,this.buffer.charCodeAt(t)},readInt8:function(t){t>>>=0;var e=this.buffer.charCodeAt(t);return 128&e?-x(e,8):e},readUInt16LE:function(t){return t>>>=0,this.buffer.charCodeAt(t)|this.buffer.charCodeAt(t+1)<<8},readInt16LE:function(t){var e=this.readUInt16LE(t);return 32768&e?-x(e,16):e},readUInt32LE:function(t){return t>>>=0,this.buffer.charCodeAt(t)|this.buffer.charCodeAt(t+1)<<8|this.buffer.charCodeAt(t+2)<<16|this.buffer.charCodeAt(t+3)<<24},readInt32LE:function(t){var e=this.readUInt32LE(t);return 2147483648&e?-x(e,32):e},readFloatLE:function(t){var e=new Float32Array(1);if(V)for(var r=0;4>r;++r)e.buffer[r]=this.readUInt8(t+r);else for(var r=3;r>=0;--r)e.buffer[r]=this.readUInt8(t+(3-r));return e[0]},readDoubleLE:function(t){var e=new Float64Array(1);if(V)for(var r=0;8>r;++r)e.buffer[r]=this.readUInt8(t+r);else for(var r=7;r>=0;--r)e.buffer[r]=this.readUInt8(t+(7-r));return e[0]}},N.prototype={exhausted:function(){return i>=this.buffer.length},readUInt8:function(){return this.i++,this.buffer.readUInt8(this.i-1)},readInt8:function(){return this.i++,this.buffer.readInt8(this.i-1)},readUInt16:function(){return this.i+=2,this.buffer.readUInt16LE(this.i-2)},readInt16:function(){return this.i+=2,this.buffer.readInt16LE(this.i-2)},readUInt32:function(){return this.i+=4,this.buffer.readUInt32LE(this.i-4)},readInt32:function(){return this.i+=4,this.buffer.readInt32LE(this.i-4)},readFloat:function(){return this.i+=4,this.buffer.readFloatLE(this.i-4)},readDouble:function(){return this.i+=8,this.buffer.readDoubleLE(this.i-8)},readValue:function(t){return t===n?this.readUInt8():t===(n|r)?this.readInt8():t===s?this.readUInt16():t===(s|r)?this.readInt16():t===a?this.readUInt32():t===(a|r)?this.readInt32():t===f?this.readFloat():t===u?this.readDouble():void 0}},m.prototype={readString:function(){for(var t="",e=this.buffer.readUInt8(),r=this.buffer.readValue(e),n=0;r>n;)t+=String.fromCharCode(this.buffer.readUInt8()),++n;return t},parseSI:function(){if(this.state&e)throw Error("Already parsed string index.");var t;switch(this.stringIndexType=this.buffer.readUInt8(),this.stringIndexType){case n:case s:case a:t=this.buffer.readValue(this.stringIndexType);break;case O:t=0;break;default:throw Error("Invalid LEON.")}for(var r=0;t>r;++r)this.stringIndex.push(this.readString());return this.state|=e,this},parseOLI:function(){if(this.state&e||this.parseSI(),!this.stringIndex.length)return this;var t,r,i,f;switch(this.OLItype=this.buffer.readUInt8(),this.OLItype){case n:case s:case a:t=this.buffer.readValue(this.OLItype);break;case O:return this;default:throw Error("Invalid LEON.")}for(i=0;t>i;++i)for(this.objectLayoutIndex.push([]),r=this.buffer.readValue(this.buffer.readUInt8()),f=0;r>f;++f)this.objectLayoutIndex[i].push(this.buffer.readValue(this.stringIndexType));return this},parseValueWithSpec:function(t){var e,r,n,i,s;if("undefined"==typeof t&&(t=this.spec),t===l)return e=this.readString();if("object"==typeof t){if(t===w)return e=this.parseValue(t);if(Array.isArray(t)){if(0===t.length)return this.parseValue(c);for(t=t[0],s=this.buffer.readUInt8(),n=this.buffer.readValue(s),e=[],r=0;n>r;++r)e.push(this.parseValueWithSpec(t));return e}for(e={},i=Object.getOwnPropertyNames(t),i.sort(function(t,e){return t>e}),r=0;r<i.length;++r)e[i[r]]=this.parseValueWithSpec(t[i[r]]);return e}return t===(p&I)?this.parseValue():this.parseValue(t)},parseValue:function(t){"undefined"==typeof t&&(t=this.buffer.readUInt8());var e,r,i,s;if(d>t)return this.buffer.readValue(t);switch(t){case c:for(t=this.buffer.readUInt8(),e=this.buffer.readValue(t),i=[],r=0;e>r;++r)i.push(this.parseValue());return i;case d:for(s=this.objectLayoutIndex[this.buffer.readValue(this.OLItype)],i={},r=0;r<s.length;++r)i[this.stringIndex[s[r]]]=this.parseValue();break;case l:return this.stringIndex[this.buffer.readValue(this.stringIndexType)];case g:return void 0;case p:return!0;case I:return!1;case b:return null;case S:return 0/0;case v:return Number.NEGATIVE_INFINITY;case L:return Number.POSITIVE_INFINITY;case w:return new Date(this.buffer.readValue(u));case y:e=this.buffer.readValue(this.buffer.readUInt8());try{i=new Buffer(e)}catch(a){try{i=StringBuffer()}catch(a){throw Error("LEON object contains a Buffer but StringBuffer has not been loaded.")}}for(r=0;e>r;++r)i.writeUInt8(this.buffer.readValue(n),r);return i;case E:return RegExp(this.readString(),this.readString());default:throw Error("Invalid LEON.")}return i}},T.prototype={append:function(e){this.buffer=t.concat([this.buffer,e])},writeData:function(){return"undefined"!=typeof this.spec?this.writeValueWithSpec(this.payload):this.writeValue(this.payload,A(this.payload)),this},"export":function(){return this.buffer.buffer},writeValueWithSpec:function(t,e){var r,n;if("undefined"==typeof e&&(e=this.spec),"object"==typeof e)if(Array.isArray(e))for(this.writeValue(t.length,A(t.length)),n=0;n<t.length;++n)this.writeValueWithSpec(t[n],e[0]);else if("[object Date]"===toString.call(t))this.writeValue(t,w,!0);else for(r=Object.getOwnPropertyNames(e),r.sort(function(t,e){return t>e}),n=0;n<r.length;++n)this.writeValueWithSpec(t[r[n]],e[r[n]]);else e===(p&I)?this.writeValue(t,A(t),!0):this.writeValue(t,e,!0)},writeValue:function(e,i,O){var V,U,x,C,N,m=t();switch(m.writeUInt8(i,0),i){case g:case p:case I:case b:case S:case v:case L:return this.append(m),1;case l:return O||this.append(m),this.stringIndex?(this.writeValue(this.stringIndex.indexOf(e),this.stringIndexType,!0),2):(this.writeString(e),2+e.length);case r:return O||this.append(m),V=t(),V.writeInt8(e,0),this.append(V),2;case n:return O||this.append(m),V=t(),V.writeUInt8(e,0),this.append(V),2;case h:return O||this.append(m),V=t(),V.writeInt16LE(e,0),this.append(V),3;case s:return O||this.append(m),V=t(),V.writeUInt16LE(e,0),this.append(V),3;case o:return O||this.append(m),V=t(),V.writeInt32LE(e,0),this.append(V),5;case a:return O||this.append(m),V=t(),V.writeUInt32LE(e,0),this.append(V),5;case f:return O||this.append(m),V=t(),V.writeFloatLE(e,0),this.append(V),5;case u:return O||this.append(m),V=t(),V.writeDoubleLE(e,0),this.append(V),9;case c:for(O||this.append(m),this.writeValue(e.length,A(e.length)),U=0;U<e.length;++U)this.writeValue(e[U],A(e[U]));break;case d:for(O||this.append(m),C=j(e,this.stringIndex,this.OLI),O||this.writeValue(C,this.OLItype,!0),U=0;U<this.OLI[C].length;++U)x=e[this.stringIndex[this.OLI[C][U]]],this.writeValue(x,A(x));break;case w:O||this.append(m),this.writeValue(e.valueOf(),u,!0);break;case y:for(O||this.append(m),this.writeValue(e.length,A(e.length)),U=0;U<e.length;++U)this.writeValue(e[U],n,!0);break;case E:return O||this.append(m),N=D(e),this.writeString(N[0]),this.writeString(N[1]),N.reduce(function(t,e){return t+e.length+1},0)}},writeString:function(t){this.writeValue(t.length,A(t.length));for(var e=0;e<t.length;++e)this.writeValue(t.charCodeAt(e),n,!0)},writeOLI:function(t){return this.stringIndex.length?(this.OLI=F(this.payload,this.stringIndex),this.OLI.length?(this.OLItype=A(this.OLI.length),this.writeValue(this.OLI.length,this.OLItype),this.OLI.forEach(function(t){var e=A(t.length);this.writeValue(t.length,e),t.forEach(function(t){this.writeValue(t,this.stringIndexType,!0)},this)},this),this):(this.writeValue(O,n,!0),this)):this},writeSI:function(){return this.stringIndex=B(this.payload),this.stringIndex.length?(this.stringIndexType=A(this.stringIndex.length),this.writeValue(this.stringIndex.length,this.stringIndexType),this.stringIndex.forEach(function(t){this.writeString(t)},this),this):(this.writeValue(O,n,!0),this)}},G.prototype={stringify:function(t){return T(t,this.spec).writeData()["export"]()},parse:function(e){return m(t(e),this.spec).parseValueWithSpec()}};var Y={};return Y.types=U,Y.parse=_,Y.stringify=W,Y.toTemplate=k,Y.Channel=G,Y}();"undefined"!=typeof exports?"undefined"!=typeof module&&module.exports&&(exports=module.exports=x):t.LEON=x}).call(this);