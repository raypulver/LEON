"use strict";(function(){var t=this,r=(t.LEON,1),e=1,n=0,s=2,f=4,h=6,u=7,a=128,o=9,d=16,c=32,p=33,l=64,I=20,g=21,b=22,w=23,y=24,E=25,S=26,L=255,V={CHAR:e|n,UNSIGNED_CHAR:n,SHORT:e|s,UNSIGNED_SHORT:s,INT:e|f,UNSIGNED_INT:f,FLOAT:h,DOUBLE:u,ARRAY:a,OBJECT:o,STRING:d,BOOLEAN:c&p,NULL:l,UNDEFINED:I,DATE:g,BUFFER:b,REGEXP:w,MINUS_INFINITY:S,POSITIVE_INFINITY:E},O=function(){function t(r){return this instanceof t?void(this.buffer=r?r:""):new t(r)}function O(t,r){var e=0;if(r>0)for(;r>e;)t*=2,e++;else for(r=-r;r>e;)t/=2,e++;return t}function v(t,r){return r>31||!r?~t:(t^x(r))+1}function x(t){return(1<<t)-1}function C(t){return this instanceof C?(this.buffer=t,void(this.i=0)):new C(t)}function U(t,r){return this instanceof U?(this.buffer=C(t),this.state=0,this.stringIndex=[],this.objectLayoutIndex=[],void(this.spec=r)):new U(t,r)}function N(t){var r;if("object"==typeof t){if(null===t)return l;if(Array.isArray(t))return a;if(r=toString.call(t),"[object Date]"===r)return g;if("[object RegExp]"===r)return w;try{if(Buffer.isBuffer(t))return b}catch(i){try{if(t instanceof StringBuffer)return b}catch(i){}}return o}if("function"==typeof t||"undefined"==typeof t)return I;if("boolean"==typeof t)return t?c:p;if("string"==typeof t)return d;if("number"==typeof t){if(t!==t)return y;if(t===Number.NEGATIVE_INFINITY)return S;if(t===Number.POSITIVE_INFINITY)return E;var L=0,V=0,O=t;if(O%1){if(O=Math.abs(O),1>O)for(;1>O;--L,O*=2);else for(;O>2;++L,O/=2);for(;O%1!==0;V++,O*=2)if(V>23)return u;return-128>L||L>127?u:h}return 0>O?Math.abs(O)<64?e|n:Math.abs(O)<16384?e|s:Math.abs(O)<1<<30?e|f:u:128>O?n:32768>O?s:O<Math.pow(2,32)?f:u}}function m(r,e){return this instanceof m?(this.payload=r,this.buffer=t(),void(this.spec=e)):new m(r,e)}function A(t,r,e){for(var i,n,s,f=0,h=Object.getOwnPropertyNames(t).map(function(t){return r.indexOf(t)}).sort(function(t,r){return t-r});f<e.length;)if(s=!1,h.length===e[f].length){for(n=e[f].slice().sort(function(t,r){return t-r}),i=0;i<h.length;++i)if(n=e[f].slice().sort(function(t,r){return t-r}),h[i]!==n[i]){s=!0;break}if(!s)return f;++f}else++f}function T(t){return t=t.toString(),[t.substr(1,t.lastIndexOf("/")-1),t.substr(t.lastIndexOf("/")+1)]}function j(t,r,e,i){var n,s;if(e||(e=[]),void 0===i&&(i=t),"object"==typeof i&&!Buffer.isBuffer(i)&&"[object RegExp]"!==toString.call(i)&&"[object Date]"!==toString.call(i)&&null!==i)for(n=Object.getOwnPropertyNames(i),Array.isArray(i)||"[object Date]"===toString.call(i)||(e.push([]),n.forEach(function(t){e[e.length-1].push(r.indexOf(t))})),s=0;s<n.length;++s)j(t,r,e,i[n[s]]);return e}function M(t,r,e){r||(r=[]),void 0===e&&(e=t);var i,n;if("object"!=typeof e||"[object RegExp]"===toString.call(e)||"[object Date]"===toString.call(e)||Buffer.isBuffer(e))"string"==typeof e&&D(r,e);else for(i=Object.getOwnPropertyNames(e),Array.isArray(e)||i.forEach(function(t){D(r,t)}),n=0;n<i.length;++n)M(t,r,e[i[n]]);return r}function D(t,r){-1===t.indexOf(r)&&t.push(r)}function F(r){return U(t(r)).parseSI().parseOLI().parseValue()}function B(t){return m(t).writeSI().writeOLI().writeData()["export"]()}function R(t){return this instanceof R?void(this.spec=t):new R(t)}t.concat=function(r){return t(r.reduce(function(t,r){return t+r.buffer},""))},t.fromString=function(r){for(var e=t(),i=0;r[i];)e.writeUInt8(r.charCodeAt(i),i),i++;return e},t.prototype={writeUInt8:function(t,r){return t=+t,r===this.buffer.length||-1===r?this.buffer+=String.fromCharCode(t):this.buffer=this.buffer.substr(0,r)+String.fromCharCode(t)+this.buffer.substr(r+1),r+1},writeInt8:function(t,r){return t=+t,t=0>t?v(-t,8):t,r===this.buffer.length||-1===r?this.buffer+=String.fromCharCode(t):this.buffer=this.buffer.substr(0,r)+String.fromCharCode(t)+this.buffer.substr(r+1),r+1},writeUInt16LE:function(t,r){return t=+t,r===this.buffer.length||-1===r?(this.buffer+=String.fromCharCode(255&t),this.buffer+=String.fromCharCode(t>>>8)):this.buffer=this.buffer.substr(0,r)+String.fromCharCode(255&t)+String.fromCharCode(t>>>8)+this.buffer.substr(r+2),r+2},writeInt16LE:function(t,r){return t=+t,t=0>t?v(-t,16):t,this.writeUInt16LE(t,r)},writeUInt32LE:function(t,r){t=+t,r===this.buffer.length||-1===r?this.buffer+=String.fromCharCode(255&t)+String.fromCharCode(t>>>8&255)+String.fromCharCode(t>>>16&255)+String.fromCharCode(t>>>24&255):this.buffer=this.buffer.substr(0,r)+String.fromCharCode(255&t)+String.fromCharCode(t>>>8&255)+String.fromCharCode(t>>>16&255)+String.fromCharCode(t>>>24&255)+this.buffer.substr(r+4)},writeInt32LE:function(t,r){return t=+t,t=0>t?v(-t,32):t,this.writeUInt32LE(t,r)},writeFloatLE:function(t,r){t=+t;var e,i,n=127,s=t;e=0>s?1:0,s=Math.abs(s),i=Math.log(s)/Math.log(2),i=i>0?Math.floor(i):Math.ceil(i),s*=Math.pow(2,-i+23),n+=i,s=Math.round(s);var f=[];f.push(e<<7),f[0]+=(254&n)>>>1,f.push((1&n)<<7),f[1]+=s>>>16&127,f.push(s>>>8&255),f.push(255&s);for(var h=f.length-1;h>=0;--h)this.writeUInt8(f[h],r+(f.length-1-h));return r+4},writeDoubleLE:function(t,r){t=+t;var e,i,n=1023,s=t;e=0>s?1:0,s=Math.abs(s),i=Math.log(s)/Math.log(2),i=i>0?Math.floor(i):Math.ceil(i),s*=Math.pow(2,-i+52),n+=i,s=Math.round(s),s=parseInt(s.toString(2).substr(1),2);var f=[];f.push(e<<7),f[0]+=n>>>4,f.push((15&n)<<4),f[1]+=15&Math.floor(O(s,-48));for(var h=40,u=0;6>u;++u,h-=8)f.push(255&Math.floor(O(s,-h)));for(u=f.length-1;u>=0;--u)this.writeUInt8(f[u],r+(f.length-1-u));return r+8},readUInt8:function(t){return t>>>=0,this.buffer.charCodeAt(t)},readInt8:function(t){t>>>=0;var r=this.buffer.charCodeAt(t);return 128&r?-v(r,8):r},readUInt16LE:function(t){return t>>>=0,this.buffer.charCodeAt(t)|this.buffer.charCodeAt(t+1)<<8},readInt16LE:function(t){var r=this.readUInt16LE(t);return 32768&r?-v(r,16):r},readUInt32LE:function(t){return t>>>=0,this.buffer.charCodeAt(t)|this.buffer.charCodeAt(t+1)<<8|this.buffer.charCodeAt(t+2)<<16|this.buffer.charCodeAt(t+3)<<24},readInt32LE:function(t){var r=this.readUInt32LE(t);return 2147483648&r?-v(r,32):r},readFloatLE:function(t){for(var r=[],e=0;4>e;++e)r.push(this.readUInt8(t+e));r.reverse();var i=(128&r[0])>>>7,n=((127&r[0])<<1)+((128&r[1])>>>7),s=0;for(r[1]&=127,e=0;2>=e;++e)s+=r[e+1]<<8*(2-e);return s|=8388608,O(i?-s:s,n-150)},readDoubleLE:function(t){for(var r=[],e=0;8>e;++e)r.push(this.readUInt8(t+e));r.reverse();var i=(128&r[0])>>>7,n=((127&r[0])<<4)+((240&r[1])>>>4),s=0;for(r[1]&=15,e=0;6>=e;++e)s+=O(r[e+1],8*(6-e));return s+=4503599627370496,O(i?-s:s,n-1075)}},C.prototype={exhausted:function(){return i>=this.buffer.length},readUInt8:function(){return this.i++,this.buffer.readUInt8(this.i-1)},readInt8:function(){return this.i++,this.buffer.readInt8(this.i-1)},readUInt16:function(){return this.i+=2,this.buffer.readUInt16LE(this.i-2)},readInt16:function(){return this.i+=2,this.buffer.readInt16LE(this.i-2)},readUInt32:function(){return this.i+=4,this.buffer.readUInt32LE(this.i-4)},readInt32:function(){return this.i+=4,this.buffer.readInt32LE(this.i-4)},readFloat:function(){return this.i+=4,this.buffer.readFloatLE(this.i-4)},readDouble:function(){return this.i+=8,this.buffer.readDoubleLE(this.i-8)},readValue:function(t){return t===n?this.readUInt8():t===(n|e)?this.readInt8():t===s?this.readUInt16():t===(s|e)?this.readInt16():t===f?this.readUInt32():t===(f|e)?this.readInt32():t===h?this.readFloat():t===u?this.readDouble():void 0}},U.prototype={readString:function(){for(var t,r="";;){if(t=this.buffer.readUInt8(),!t)break;r+=String.fromCharCode(t)}return r},parseSI:function(){if(this.state&r)throw Error("Already parsed string index.");var t;switch(this.stringIndexType=this.buffer.readUInt8(),this.stringIndexType){case n:case s:case f:t=this.buffer.readValue(this.stringIndexType);break;case L:t=0;break;default:throw Error("Invalid LEON.")}for(var e=0;t>e;++e)this.stringIndex.push(this.readString());return this.state|=r,this},parseOLI:function(){if(this.state&r||this.parseSI(),!this.stringIndex.length)return this;var t,e,i,h;switch(this.OLItype=this.buffer.readUInt8(),this.OLItype){case n:case s:case f:t=this.buffer.readValue(this.OLItype);break;case L:return this;default:throw Error("Invalid LEON.")}for(i=0;t>i;++i)for(this.objectLayoutIndex.push([]),e=this.buffer.readValue(this.buffer.readUInt8()),h=0;e>h;++h)this.objectLayoutIndex[i].push(this.buffer.readValue(this.stringIndexType));return this},parseValueWithSpec:function(t){var r,e,i,n,s;if("undefined"==typeof t&&(t=this.spec),t===d)return this.readString();if("object"==typeof t){if(t===g)return this.parseValue(t);if(Array.isArray(t)){if(0===t.length)return this.parseValue(a);for(t=t[0],s=this.buffer.readUInt8(),i=this.buffer.readValue(s),r=[],e=0;i>e;++e)r.push(this.parseValueWithSpec(t));return r}for(r={},n=Object.getOwnPropertyNames(t),n.sort(function(t,r){return t-r}),e=0;e<n.length;++e)r[n[e]]=this.parseValueWithSpec(t[n[e]]);return r}return t===(c&p)?this.parseValue():this.parseValue(t)},parseValue:function(t){t||(t=this.buffer.readUInt8());var r,e,i,s;if(o>t)return this.buffer.readValue(t);if(t===a){for(t=this.buffer.readUInt8(),r=this.buffer.readValue(t),i=[],e=0;r>e;++e)i.push(this.parseValue());return i}if(t!==o){if(t===d)return this.stringIndex[this.buffer.readValue(this.stringIndexType)];if(t===I)return void 0;if(t===c)return!0;if(t===p)return!1;if(t===l)return null;if(t===y)return 0/0;if(t===S)return Number.NEGATIVE_INFINITY;if(t===E)return Number.POSITIVE_INFINITY;if(t===g)return new Date(1e3*this.buffer.readValue(f));if(t===b){r=this.buffer.readValue(this.buffer.readUInt8());try{i=new Buffer(r)}catch(h){try{i=StringBuffer()}catch(h){throw Error("LEON object contains a Buffer but StringBuffer has not been loaded.")}}for(e=0;r>e;++e)i.writeUInt8(this.buffer.readValue(n),e);return i}if(t===w)return RegExp(this.readString(),this.readString());throw Error("Invalid LEON.")}for(s=this.objectLayoutIndex[this.buffer.readValue(this.OLItype)],i={},e=0;e<s.length;++e)i[this.stringIndex[s[e]]]=this.parseValue();return i}},m.prototype={append:function(r){this.buffer=t.concat([this.buffer,r])},writeData:function(){return this.spec?this.writeValueWithSpec(this.payload):this.writeValue(this.payload,N(this.payload)),this},"export":function(){return this.buffer.buffer},writeValueWithSpec:function(t,r){var e,i;if(r||(r=this.spec),"object"==typeof r)if(Array.isArray(r))for(this.writeValue(t.length,N(t.length)),i=0;i<t.length;++i)this.writeValueWithSpec(t[i],r[0]);else if("[object Date]"===toString.call(t))this.writeValue(t,g,!0);else for(e=Object.getOwnPropertyNames(r),e.sort(function(t,r){return t-r}),i=0;i<e.length;++i)this.writeValueWithSpec(t[e[i]],r[e[i]]);else r===(c&p)?this.writeValue(t,N(t),!0):this.writeValue(t,r,!0)},writeValue:function(r,i,L){var V,O,v,x,C,U=t();if(U.writeUInt8(i,0),i===I||i===c||i===p||i===l||i===y||i===S||i===E)return this.append(U),1;if(i===d)return L||this.append(U),this.stringIndex?(this.writeValue(this.stringIndex.indexOf(r),this.stringIndexType,!0),2):(this.writeString(r),2+r.length);if(i===(e|n))return L||this.append(U),V=t(),V.writeInt8(r,0),this.append(V),2;if(i===n)return L||this.append(U),V=t(),V.writeUInt8(r,0),this.append(V),2;if(i===(e|s))return L||this.append(U),V=t(),V.writeInt16LE(r,0),this.append(V),3;if(i===s)return L||this.append(U),V=t(),V.writeUInt16LE(r,0),this.append(V),3;if(i===(e|f))return L||this.append(U),V=t(),V.writeInt32LE(r,0),this.append(V),5;if(i===f)return L||this.append(U),V=t(),V.writeUInt32LE(r,0),this.append(V),5;if(i===h)return L||this.append(U),V=t(),V.writeFloatLE(r,0),this.append(V),5;if(i===u)return L||this.append(U),V=t(),V.writeDoubleLE(r,0),this.append(V),9;if(i===a)for(L||this.append(U),this.writeValue(r.length,N(r.length)),O=0;O<r.length;++O)this.writeValue(r[O],N(r[O]));if(i===o)for(L||this.append(U),x=A(r,this.stringIndex,this.OLI),L||this.writeValue(x,this.OLItype,!0),O=0;O<this.OLI[x].length;++O)v=r[this.stringIndex[this.OLI[x][O]]],this.writeValue(v,N(v));if(i===g&&(L||this.append(U),this.writeValue(Math.floor(r.valueOf()/1e3),f,!0)),i===b)for(L||this.append(U),this.writeValue(r.length,N(r.length)),O=0;O<r.length;++O)this.writeValue(r[O],n,!0);return i===w?(L||this.append(U),C=T(r),this.writeString(C[0]),this.writeString(C[1]),C.reduce(function(t,r){return t+r.length+1},0)):void 0},writeString:function(r){var e=t();e.writeUInt8(0,0),this.append(t.concat([t.fromString(String(r)),e]))},writeOLI:function(t){return this.stringIndex.length?(this.OLI=j(this.payload,this.stringIndex),this.OLI.length?(this.OLItype=N(this.OLI.length),this.writeValue(this.OLI.length,this.OLItype),this.OLI.forEach(function(t){var r=N(t.length);this.writeValue(t.length,r),t.forEach(function(t){this.writeValue(t,this.stringIndexType,!0)},this)},this),this):(this.writeValue(L,n,!0),this)):this},writeSI:function(){return this.stringIndex=M(this.payload),this.stringIndex.length?(this.stringIndexType=N(this.stringIndex.length),this.writeValue(this.stringIndex.length,this.stringIndexType),this.stringIndex.forEach(function(t){this.writeString(t)},this),this):(this.writeValue(L,n,!0),this)}},R.prototype={stringify:function(t){return m(t,this.spec).writeData()["export"]()},parse:function(r){return U(t(r),this.spec).parseValueWithSpec()}};var P={};return P.types=V,P.parse=F,P.stringify=B,P.Channel=R,P}();"undefined"!=typeof exports?"undefined"!=typeof module&&module.exports&&(exports=module.exports=O):t.LEON=O}).call(this);