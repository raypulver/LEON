"use strict";(function(){var t=this,e=(t.LEON,1),r=1,n=0,s=2,f=4,h=6,u=7,a=128,o=9,d=16,p=32,c=33,l=64,I=20,b=21,g=22,w=23,y=24,L=255,S={};S.SignedChar=r|n,S.Char=n,S.SignedShort=r|s,S.Short=s,S.SignedInt=r|f,S.Int=f,S.Float=h,S.Double=u,S.Array=a,S.Object=o,S.String=d,S.Boolean=p&c,S.Null=l,S.Undefined=I,S.Date=b,S.Buffer=g,S.RegExp=w;var V=function(){function V(t){return this instanceof V?void(this.buffer=t?t:""):new V(t)}function v(t,e){return e>31?~t:(t^x(e))+1}function x(t){return(1<<t)-1}function C(t){return this instanceof C?(this.buffer=t,void(this.i=0)):new C(t)}function E(t,e){return this instanceof E?(this.buffer=C(t),this.state=0,this.stringIndex=[],this.objectLayoutIndex=[],void(this.spec=e)):new E(t,e)}function O(e){var i;if("object"==typeof e)return null===e?l:Array.isArray(e)?a:(i=toString.call(e),"[object Date]"===i?b:"[object RegExp]"===i?w:"undefined"!=typeof t.Buffer&&Buffer.isBuffer(e)?g:o);if("function"==typeof e||"undefined"==typeof e)return I;if("boolean"==typeof e)return e?p:c;if("string"==typeof e)return d;if("number"==typeof e){if(e!==e)return y;var L=0,S=0,V=e;if(V%1){if(V=Math.abs(V),1>V)for(;1>V;--L,V*=2);else for(;V>2;++L,V/=2);for(;V%1!==0;S++,V*=2)if(S>23)return u;return-128>L||L>127?u:h}return 0>V?Math.abs(V)<128?r|n:Math.abs(V)<32768?r|s:r|f:256>V?n:65536>V?s:f}}function U(t,e){return this instanceof U?(this.payload=t,this.buffer=V(),void(this.spec=e)):new U(t,e)}function m(t,e,r){for(var i,n,s,f=0,h=Object.getOwnPropertyNames(t).map(function(t){return e.indexOf(t)}).sort(function(t,e){return t-e});f<r.length;)if(s=!1,h.length===r[f].length){for(n=r[f].slice().sort(function(t,e){return t-e}),i=0;i<h.length;++i)if(n=r[f].slice().sort(function(t,e){return t-e}),h[i]!==n[i]){s=!0;break}if(!s)return f;++f}else++f}function A(t,e,r,i){var n,s;if(r||(r=[]),void 0===i&&(i=t),"object"==typeof i&&null!==i)for(n=Object.getOwnPropertyNames(i),Array.isArray(i)||"[object Date]"===toString.call(i)||(r.push([]),n.forEach(function(t){r[r.length-1].push(e.indexOf(t))})),s=0;s<n.length;++s)A(t,e,r,i[n[s]]);return r}function j(t,e,r){e||(e=[]),void 0===r&&(r=t);var i,n;if("object"==typeof r)for(i=Object.keys(r),Array.isArray(r)||i.forEach(function(t){D(e,t)}),n=0;n<i.length;++n)j(t,e,r[i[n]]);else"string"==typeof r&&D(e,r);return e}function D(t,e){-1===t.indexOf(e)&&t.push(e)}function M(t){return E(V(t)).parseSI().parseOLI().parseValue()}function N(t){return U(t).writeSI().writeOLI().writeData()["export"]()}function T(t){return this instanceof T?void(this.spec=t):new T(t)}V.concat=function(t){return V(t.reduce(function(t,e){return t+e.buffer},""))},V.fromString=function(t){for(var e=V(),r=0;t[r];)e.writeUInt8(t.charCodeAt(r),r),r++;return e},V.prototype={writeUInt8:function(t,e){return t=+t,e===this.buffer.length||-1===e?this.buffer+=String.fromCharCode(t):this.buffer=this.buffer.substr(0,e)+String.fromCharCode(t)+this.buffer.substr(e+1),e+1},writeInt8:function(t,e){return t=+t,t=0>t?v(-t,8):t,e===this.buffer.length||-1===e?this.buffer+=String.fromCharCode(t):this.buffer=this.buffer.substr(0,e)+String.fromCharCode(t)+this.buffer.substr(e+1),e+1},writeUInt16LE:function(t,e){return t=+t,e===this.buffer.length||-1===e?(this.buffer+=String.fromCharCode(255&t),this.buffer+=String.fromCharCode(t>>>8)):this.buffer=this.buffer.substr(0,e)+String.fromCharCode(255&t)+String.fromCharCode(t>>>8)+this.buffer.substr(e+2),e+2},writeInt16LE:function(t,e){return t=+t,t=0>t?v(-t,16):t,this.writeUInt16LE(t,e)},writeUInt32LE:function(t,e){t=+t,e===this.buffer.length||-1===e?this.buffer+=String.fromCharCode(255&t)+String.fromCharCode(t>>>8&255)+String.fromCharCode(t>>>16&255)+String.fromCharCode(t>>>24&255):this.buffer=this.buffer.substr(0,e)+String.fromCharCode(255&t)+String.fromCharCode(t>>>8&255)+String.fromCharCode(t>>>16&255)+String.fromCharCode(t>>>24&255)+this.buffer.substr(e+4)},writeInt32LE:function(t,e){return t=+t,t=0>t?v(-t,32):t,this.writeUInt32LE(t,e)},writeFloatLE:function(t,e){t=+t;var r,i=127,n=t;if(r=0>n?1:0,n=Math.abs(n),1>n)for(;1>n;)n*=2,i--;else if(n>=2)for(;n>2;)n/=2,i++;for(;8388607>n;)n*=2,i--;n=Math.floor(n),r&&(n=v(n,24));var s=[];s.push(r<<7),s[0]+=(254&i)>>>1,s.push((1&i)<<7),s[1]+=n>>>16&127,s.push(n>>>8&255),s.push(255&n);for(var f=s.length-1;f>=0;--f)this.writeUInt8(s[f],e+(s.length-1-f));return e+4},writeDoubleLE:function(t,e){t=+t;var r,i=1023,n=t;if(r=0>n?1:0,n=Math.abs(n),1>n)for(;1>n;)n*=2,i--;else if(n>=2)for(;n>2;)n/=2,i++;for(;1048575>n;)n*=2,i--;n=Math.floor(n),n&=0xfffffffffffff;var s=[];s.push(r<<7),s[0]+=i>>>4,s.push((15&i)<<4),s[1]+=n>>>48&15;for(var f=40,h=0;6>h;++h,f-=8)s.push(n>>>f&255);for(h=s.length-1;h>=0;--h)this.writeUInt8(s[h],e+(s.length-1-h));return e+8},readUInt8:function(t){return t>>>=0,this.buffer.charCodeAt(t)},readInt8:function(t){t>>>=0;var e=this.buffer.charCodeAt(t);return 128&e?-v(e,8):e},readUInt16LE:function(t){return t>>>=0,this.buffer.charCodeAt(t)|this.buffer.charCodeAt(t+1)<<8},readInt16LE:function(t){var e=this.readUInt16LE(t);return 32768&e?-v(e,16):e},readUInt32LE:function(t){return t>>>=0,this.buffer.charCodeAt(t)|this.buffer.charCodeAt(t+1)<<8|this.buffer.charCodeAt(t+2)<<16|this.buffer.charCodeAt(t+3)<<24},readInt32LE:function(t){var e=this.readUInt32LE(t);return 2147483648&e?-v(e,32):e},readFloatLE:function(t){for(var e,r=[],i=0;4>i;++i)r.push(this.readUInt8(t+i));r.reverse();var n=(128&r[0])>>>7,s=((127&r[0])<<1)+((128&r[1])>>>7),f=0;for(r[1]&=127,i=0;2>=i;++i)f+=r[i+1]<<8*(2-i);return n?(f=-v(f,24),f&=-8388609):f|=8388608,e=f*Math.pow(2,s-127)},readDoubleLE:function(t){for(var e=[],r=0;8>r;++r)e.push(this.readUInt8(t+r));e.reverse();var i=(128&e[0])>>>7,n=((127&e[0])<<4)+((240&e[1])>>>4),s=0;for(e[1]&=15,r=0;6>=r;++r)s+=e[r+1]*Math.pow(2,8*(6-r));return i?s=-v(s):s|=4503599627370496,s*Math.pow(2,n-1023)}},C.prototype={exhausted:function(){return i>=this.buffer.length},readUInt8:function(){return this.i++,this.buffer.readUInt8(this.i-1)},readInt8:function(){return this.i++,this.buffer.readInt8(this.i-1)},readUInt16:function(){return this.i+=2,this.buffer.readUInt16LE(this.i-2)},readInt16:function(){return this.i+=2,this.buffer.readInt16LE(this.i-2)},readUInt32:function(){return this.i+=4,this.buffer.readUInt32LE(this.i-4)},readInt32:function(){return this.i+=4,this.buffer.readInt32LE(this.i-4)},readFloat:function(){return this.i+=4,this.buffer.readFloatLE(this.i-4)},readDouble:function(){return this.i+=8,this.buffer.readDoubleLE(this.i-8)},readValue:function(t){return t===n?this.readUInt8():t===(n|r)?this.readInt8():t===s?this.readUInt16():t===(s|r)?this.readInt16():t===f?this.readUInt32():t===(f|r)?this.readInt32():t===h?this.readFloat():t===u?this.readDouble():void 0}},E.prototype={readString:function(){for(var t,e="";;){if(t=this.buffer.readUInt8(),!t)break;e+=String.fromCharCode(t)}return e},parseSI:function(){if(this.state&e)throw Error("Already parsed string index.");var t;switch(this.stringIndexType=this.buffer.readUInt8(),this.stringIndexType){case n:case s:case f:t=this.buffer.readValue(this.stringIndexType);break;case L:t=0;break;default:throw Error("Invalid LEON.")}for(var r=0;t>r;++r)this.stringIndex.push(this.readString());return this.state|=e,this},parseOLI:function(){if(this.state&e||this.parseSI(),!this.stringIndex.length)return this;var t,r,i,h;switch(this.OLItype=this.buffer.readUInt8(),this.OLItype){case n:case s:case f:t=this.buffer.readValue(this.OLItype);break;case L:return this;default:throw Error("Invalid LEON.")}for(i=0;t>i;++i)for(this.objectLayoutIndex.push([]),r=this.buffer.readValue(this.buffer.readUInt8()),h=0;r>h;++h)this.objectLayoutIndex[i].push(this.buffer.readValue(this.stringIndexType));return this},parseValueWithSpec:function(t){var e,r,i,n,s;if("undefined"==typeof t&&(t=this.spec),t===d)return this.readString();if("object"==typeof t){if(t===b)return this.parseValue(t);if(Array.isArray(t)){if(0===t.length)return this.parseValue(a);for(t=t[0],s=this.buffer.readUInt8(),i=this.buffer.readValue(s),e=[],r=0;i>r;++r)e.push(this.parseValueWithSpec(t));return e}for(e={},n=Object.getOwnPropertyNames(t),n.sort(function(t,e){return t-e}),r=0;r<n.length;++r)e[n[r]]=this.parseValueWithSpec(t[n[r]]);return e}return t===(p&c)?this.parseValue():this.parseValue(t)},parseValue:function(t){t||(t=this.buffer.readUInt8());var e,r,i,s;if(o>t)return this.buffer.readValue(t);if(t===a){for(t=this.buffer.readUInt8(),e=this.buffer.readValue(t),i=[],r=0;e>r;++r)i.push(this.parseValue());return i}if(t!==o){if(t===d)return this.stringIndex[this.buffer.readValue(this.stringIndexType)];if(t===I)return void 0;if(t===p)return!0;if(t===c)return!1;if(t===l)return null;if(t===y)return 0/0;if(t===b)return new Date(1e3*this.buffer.readValue(f));if(t===g){for(e=this.buffer.readValue(this.buffer.readUInt8()),i=new Buffer(e),r=0;e>r;++r)i.writeUInt8(this.buffer.readValue(n),r);return i}if(t===w)return RegExp(this.readString());throw Error("Invalid LEON.")}for(s=this.objectLayoutIndex[this.buffer.readValue(this.OLItype)],i={},r=0;r<s.length;++r)i[this.stringIndex[s[r]]]=this.parseValue();return i}},U.prototype={append:function(t){this.buffer=V.concat([this.buffer,t])},writeData:function(){return this.spec?this.writeValueWithSpec(this.payload):this.writeValue(this.payload,O(this.payload)),this},"export":function(){return this.buffer.buffer},writeValueWithSpec:function(t,e){var r,i;if(e||(e=this.spec),"object"==typeof e)if(Array.isArray(e))for(this.writeValue(t.length,O(t.length)),i=0;i<t.length;++i)this.writeValueWithSpec(t[i],e[0]);else if("[object Date]"===toString.call(t))this.writeValue(t,b,!0);else for(r=Object.getOwnPropertyNames(e),r.sort(function(t,e){return t-e}),i=0;i<r.length;++i)this.writeValueWithSpec(t[r[i]],e[r[i]]);else e===(p&c)?this.writeValue(t,O(t),!0):this.writeValue(t,e,!0)},writeValue:function(t,e,i){var L,S,v,x,C=V();if(C.writeUInt8(e,0),e===I||e===p||e===c||e===l||e===y)return this.append(C),1;if(e===d)return i||this.append(C),this.stringIndex?(this.writeValue(this.stringIndex.indexOf(t),this.stringIndexType,!0),2):(this.writeString(t),2+t.length);if(e===(r|n))return i||this.append(C),L=V(),L.writeInt8(t,0),this.append(L),2;if(e===n)return i||this.append(C),L=V(),L.writeUInt8(t,0),this.append(L),2;if(e===(r|s))return i||this.append(C),L=V(),L.writeInt16LE(t,0),this.append(L),3;if(e===s)return i||this.append(C),L=V(),L.writeUInt16LE(t,0),this.append(L),3;if(e===(r|f))return i||this.append(C),L=V(),L.writeInt32LE(t,0),this.append(L),5;if(e===f)return i||this.append(C),L=V(),L.writeUInt32LE(t,0),this.append(L),5;if(e===h)return i||this.append(C),L=V(),L.writeFloatLE(t,0),this.append(L),5;if(e===u)return i||this.append(C),L=V(),L.writeDoubleLE(t,0),this.append(L),9;if(e===a)for(i||this.append(C),this.writeValue(t.length,O(t.length)),S=0;S<t.length;++S)this.writeValue(t[S],O(t[S]));if(e===o)for(i||this.append(C),x=m(t,this.stringIndex,this.OLI),i||this.writeValue(x,this.OLItype,!0),S=0;S<this.OLI[x].length;++S)v=t[this.stringIndex[this.OLI[x][S]]],this.writeValue(v,O(v));if(e===b&&(i||this.append(C),this.writeValue(Math.floor(t.valueOf()/1e3),f,!0)),e===g)for(i||this.append(C),S=0;S<t.length;++S)this.writeValue(t[S],n,!0);e===w&&(i||this.append(C),this.writeString(t.toString()))},writeString:function(t){var e=V();e.writeUInt8(0,0),this.append(V.concat([V.fromString(String(t)),e]))},writeOLI:function(t){return this.stringIndex.length?(this.OLI=A(this.payload,this.stringIndex),this.OLI.length?(this.OLItype=O(this.OLI.length),this.writeValue(this.OLI.length,this.OLItype),this.OLI.forEach(function(t){var e=O(t.length);this.writeValue(t.length,e),t.forEach(function(t){this.writeValue(t,this.stringIndexType,!0)},this)},this),this):(this.writeValue(L,n,!0),this)):this},writeSI:function(){return this.stringIndex=j(this.payload),this.stringIndex.length?(this.stringIndexType=O(this.stringIndex.length),this.writeValue(this.stringIndex.length,this.stringIndexType),this.stringIndex.forEach(function(t){this.writeString(t)},this),this):(this.writeValue(L,n,!0),this)}},T.prototype={stringify:function(t){return U(t,this.spec).writeData()["export"]()},parse:function(t){return E(V(t),this.spec).parseValueWithSpec()}};var W={};return W.types=S,W.parse=M,W.stringify=N,W.complement=v,W.Channel=T,W}();"undefined"!=typeof exports?"undefined"!=typeof module&&module.exports&&(exports=module.exports=V):t.LEON=V}).call(this);